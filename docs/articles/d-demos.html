<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Demos • patter</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Demos">
<meta property="og:description" content="patter">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">patter</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/a-methodology.html">Methodology</a>
    </li>
    <li>
      <a href="../articles/b-workflow-outline.html">Workflow outline</a>
    </li>
    <li>
      <a href="../articles/c-workflow-example.html">Example workflow</a>
    </li>
    <li>
      <a href="../articles/d-demos.html">Demos</a>
    </li>
    <li>
      <a href="../articles/e-faqs.html">FAQs</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/edwardlavender/patter/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Demos</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/edwardlavender/patter/blob/HEAD/vignettes/d-demos.Rmd" class="external-link"><code>vignettes/d-demos.Rmd</code></a></small>
      <div class="hidden name"><code>d-demos.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This vignette provides extended demonstrations of selected
<code>patter</code> functions.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Essential packages </span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edwardlavender/patter/" class="external-link">patter</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dtplyr.tidyverse.org" class="external-link">dtplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://testthat.r-lib.org" class="external-link">testthat</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set global options</span></span>
<span><span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>patter.verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="convergence">Convergence<a class="anchor" aria-label="anchor" href="#convergence"></a>
</h2>
<p>This demonstration illustrates convergence challenges in
<code><a href="../reference/pf_forward.html">pf_forward()</a></code>. Convergence is the complete reconstruction of
possible locations for an individual from the start to the end of the
time series. A convergence failure occurs when the simulation fails to
reach the end of the time series; i.e. it reaches a time step at which,
given previously sampled locations, there are no valid locations into
which the algorithm can step next. Convergence failures can result from
erroneous observations or assumptions but they are also dependent upon
the sampling strategy. Assuming that our observations and assumptions
are correct, this demonstration shows how we can improve efficiency and
convergence by tuning selected algorithm parameters related to the
sampling strategy. We simulate a hypothetical study area and movement
time series. The parameters of the simulation are chosen such that the
data uniquely define the individual’s location with complete certainty.
We then implement the forward simulation of individual movements via
<code><a href="../reference/pf_forward.html">pf_forward()</a></code>. Given the selected parameters, there is only
one possible location for the individual at each time step and this
makes convergence difficult, but we successfully achieve convergence by
tuning the sampling strategy. At the end of the process, we validate the
outputs and demonstrate successful reconstruction of the one true
movement path.</p>
<div class="section level3">
<h3 id="simulate-data">Simulate data<a class="anchor" aria-label="anchor" href="#simulate-data"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="do">#### Define study area</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="co"># Define high-resolution grid</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>gebco <span class="ot">&lt;-</span> <span class="fu">dat_gebco</span>()</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>gebco <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(gebco, terra<span class="sc">::</span><span class="fu">ext</span>(<span class="fl">706828.9</span>, <span class="fl">711135.5</span>, <span class="dv">6256889</span>, <span class="dv">6262960</span>))</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>gebco <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">disagg</span>(gebco, <span class="at">fact =</span> <span class="dv">50</span>)</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="sc">|---------</span><span class="er">|</span><span class="sc">---------</span><span class="er">|</span><span class="sc">---------</span><span class="er">|</span><span class="sc">---------</span><span class="er">|</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="er">==</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>                                          </span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="co"># For demonstration purposes, modify depths to uniquely define grid cells</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="fu">ss</span>()</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>gebco[] <span class="ot">&lt;-</span> gebco[] <span class="sc">+</span> <span class="dv">10</span> <span class="sc">+</span> <span class="fu">runif</span>(<span class="fu">length</span>(gebco[]), <span class="dv">0</span>, <span class="dv">15</span>) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(gebco[]))</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">duplicated</span>(<span class="fu">na.omit</span>(gebco[])))</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a><span class="co">#&gt;   FALSE </span></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a><span class="co">#&gt; 6552500</span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">any</span>(gebco[] <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a><span class="do">#### Define study period</span></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>period <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">as.POSIXct</span>(<span class="st">"2016-01-01"</span>, <span class="at">tz =</span> <span class="st">"UTC"</span>), <span class="at">by =</span> <span class="st">"2 mins"</span>, <span class="at">length =</span> 500L)</span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a><span class="do">#### Simulate array &amp; path</span></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a><span class="co"># Simulate array</span></span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a><span class="fu">ss</span>()</span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>array <span class="ot">&lt;-</span> <span class="fu">sim_array</span>(gebco,</span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>                   <span class="at">.n_receiver =</span> <span class="dv">50</span>,</span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>                   <span class="at">.receiver_range =</span> <span class="dv">750</span>,</span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a>                   <span class="at">.receiver_start =</span> <span class="fu">as.Date</span>(<span class="st">"2016-01-01"</span>),</span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a>                   <span class="at">.receiver_end =</span> <span class="fu">as.Date</span>(<span class="st">"2017-01-01"</span>))</span></code></pre></div>
<p><img src="d-demos_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate movement path</span></span>
<span><span class="va">origin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">709144.3</span>, <span class="fl">6261561</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sim_helpers.html">ss</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_path_walk.html">sim_path_walk</a></span><span class="op">(</span>.bathy <span class="op">=</span> <span class="va">gebco</span>,</span>
<span>                      .origin <span class="op">=</span> <span class="va">origin</span>,</span>
<span>                      .n_step <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">period</span><span class="op">)</span>,</span>
<span>                      .timestamp <span class="op">=</span> <span class="va">period</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#### Simulate observations</span></span>
<span><span class="co"># Simulate detections</span></span>
<span><span class="va">acoustics</span>           <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_detections.html">sim_detections</a></span><span class="op">(</span><span class="va">path</span>, <span class="va">array</span><span class="op">)</span></span>
<span><span class="co"># Simulate archival observations</span></span>
<span><span class="co"># * For demonstration purposes, we assume depth is observed perfectly</span></span>
<span><span class="va">archival</span>            <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>timestep <span class="op">=</span> <span class="va">path</span><span class="op">$</span><span class="va">timestep</span>, depth <span class="op">=</span> <span class="va">path</span><span class="op">$</span><span class="va">cell_z</span><span class="op">)</span></span>
<span><span class="va">archival</span><span class="op">$</span><span class="va">timestamp</span>  <span class="op">&lt;-</span> <span class="va">period</span></span>
<span></span>
<span><span class="co">#### Collect datasets for `pf_forward()`</span></span>
<span><span class="va">dlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pat_setup_data.html">pat_setup_data</a></span><span class="op">(</span>.acoustics <span class="op">=</span> <span class="va">acoustics</span>,</span>
<span>                        .moorings <span class="op">=</span> <span class="va">array</span>,</span>
<span>                        .archival <span class="op">=</span> <span class="va">archival</span>,</span>
<span>                        .bathy <span class="op">=</span> <span class="va">gebco</span>,</span>
<span>                        .lonlat <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># Include algorithm layers</span></span>
<span><span class="va">dlist</span><span class="op">$</span><span class="va">algorithm</span><span class="op">$</span><span class="va">detection_overlaps</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/acs_setup_detection_overlaps.html">acs_setup_detection_overlaps</a></span><span class="op">(</span><span class="va">dlist</span><span class="op">)</span></span>
<span><span class="va">dlist</span><span class="op">$</span><span class="va">algorithm</span><span class="op">$</span><span class="va">detection_kernels</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/acs_setup_detection_kernels.html">acs_setup_detection_kernels</a></span><span class="op">(</span><span class="va">dlist</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#### Collect observations for `pf_forward()`</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pf_setup_obs.html">pf_setup_obs</a></span><span class="op">(</span>.dlist <span class="op">=</span> <span class="va">dlist</span>,</span>
<span>                    .step <span class="op">=</span> <span class="st">"2 mins"</span>,</span>
<span>                    .mobility <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                    .receiver_range <span class="op">=</span> <span class="fl">750</span><span class="op">)</span></span></code></pre></div>
<p><img src="d-demos_files/figure-html/unnamed-chunk-2-2.png" width="700"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs</span><span class="op">[</span>, <span class="va">depth_shallow</span> <span class="op">:=</span> <span class="va">depth</span><span class="op">]</span></span>
<span><span class="va">obs</span><span class="op">[</span>, <span class="va">depth_deep</span> <span class="op">:=</span> <span class="va">depth</span><span class="op">]</span></span>
<span><span class="va">obs_sbt</span> <span class="op">&lt;-</span> <span class="va">obs</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10L</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co">#### Define models for `pf_forward()`</span></span>
<span><span class="co"># Proposal functions (movement model)</span></span>
<span><span class="co"># * For speed, use use the defaults</span></span>
<span><span class="co"># Likelihood functions</span></span>
<span><span class="co"># * We use the default convenience functions for the ACPF and ACDCPF algorithms</span></span>
<span><span class="va">pf_lik_acpf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>acs_filter_land <span class="op">=</span> <span class="va">acs_filter_land</span>,</span>
<span>                    acs_filter_container <span class="op">=</span> <span class="va">acs_filter_container</span>,</span>
<span>                    pf_lik_ac <span class="op">=</span> <span class="va">pf_lik_ac</span><span class="op">)</span></span>
<span><span class="va">pf_lik_acdcpf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>acs_filter_land <span class="op">=</span> <span class="va">acs_filter_land</span>,</span>
<span>                      acs_filter_container <span class="op">=</span> <span class="va">acs_filter_container</span>,</span>
<span>                      pf_lik_ac <span class="op">=</span> <span class="va">pf_lik_ac</span>,</span>
<span>                      pf_lik_dc <span class="op">=</span> <span class="va">pf_lik_dc</span><span class="op">)</span></span>
<span><span class="co"># Sampling function</span></span>
<span><span class="co"># * We use the defaults</span></span>
<span></span>
<span><span class="co">#### Define supporting arguments for `pf_forward()`</span></span>
<span><span class="va">record</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pf_opt.html">pf_opt_record</a></span><span class="op">(</span>.save <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="forward-simulation">Forward simulation<a class="anchor" aria-label="anchor" href="#forward-simulation"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#### (1) ACPF forward simulation (default options)</span></span>
<span><span class="co"># &gt; The algorithm easy converges</span></span>
<span><span class="co"># &gt; This makes sense</span></span>
<span><span class="co"># &gt; The combination of observations &amp; the observation model is not very restrictive</span></span>
<span><span class="co"># &gt; There are many routes across the landscape &amp; it is easy to find possibilities</span></span>
<span><span class="fu"><a href="../reference/sim_helpers.html">ss</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">out_pff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pf_forward.html">pf_forward</a></span><span class="op">(</span>.obs <span class="op">=</span> <span class="va">obs_sbt</span>,</span>
<span>                      .dlist <span class="op">=</span> <span class="va">dlist</span>,</span>
<span>                      .likelihood <span class="op">=</span> <span class="va">pf_lik_acpf</span>,</span>
<span>                      .record <span class="op">=</span> <span class="va">record</span>, </span>
<span>                      .control <span class="op">=</span> <span class="fu"><a href="../reference/pf_opt.html">pf_opt_control</a></span><span class="op">(</span>.sampler_batch_size <span class="op">=</span> <span class="fl">100L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="va">out_pff</span><span class="op">$</span><span class="va">convergence</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#### (2) ACDCPF forward simulation (enforce kick proposals only)</span></span>
<span></span>
<span><span class="co"># (A) Implement simulation with default options (apart from .trial_sampler)</span></span>
<span><span class="co"># &gt; This fails to converge</span></span>
<span><span class="fu"><a href="../reference/sim_helpers.html">ss</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">out_pff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pf_forward.html">pf_forward</a></span><span class="op">(</span>.obs <span class="op">=</span> <span class="va">obs_sbt</span>,</span>
<span>                      .dlist <span class="op">=</span> <span class="va">dlist</span>,</span>
<span>                      .likelihood <span class="op">=</span> <span class="va">pf_lik_acdcpf</span>,</span>
<span>                      <span class="co"># Set `.trial_sampler` = 0L to suppress directed sampling</span></span>
<span>                      .trial <span class="op">=</span> <span class="fu"><a href="../reference/pf_opt.html">pf_opt_trial</a></span><span class="op">(</span>.trial_sampler <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span>,</span>
<span>                      .record <span class="op">=</span> <span class="va">record</span></span>
<span>                      <span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Convergence error: there are no particles with positive weights at</span></span>
<span><span class="co">#&gt; time step 2. Returning outputs up to time step 2.</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_false</a></span><span class="op">(</span><span class="va">out_pff</span><span class="op">$</span><span class="va">convergence</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># (B) Examine diagnostics to pin down the causes of convergence failures</span></span>
<span><span class="co"># &gt; All particles are surviving the AC* filters</span></span>
<span><span class="co"># &gt; (base n_u == pf_lik_ac).</span></span>
<span><span class="co"># &gt; This makes sense b/c after the first time step detections weren't recorded</span></span>
<span><span class="co"># &gt; and, in this sparse array, information in detection gaps is limited, see:</span></span>
<span><span class="co"># &gt; obs_sbt[, detection]</span></span>
<span><span class="co"># &gt; However, the depth likelihood term kills all but one proposal on each trial.</span></span>
<span><span class="co"># &gt; This makes sense b/c we defined a v. stringent observation model.</span></span>
<span><span class="co"># &gt; The obvious solution here is to enforce directed sampling, but</span></span>
<span><span class="co"># &gt; for demonstration, we will explore some other options first.</span></span>
<span><span class="va">out_pff</span><span class="op">$</span><span class="va">diagnostics</span></span>
<span><span class="co">#&gt;     iter_m iter_i timestep                component trial      n    n_u</span></span>
<span><span class="co">#&gt;  1:      1      1        1                 proposal    NA 376228 376228</span></span>
<span><span class="co">#&gt;  2:      1      1        1      lik-acs_filter_land    NA 376228 376228</span></span>
<span><span class="co">#&gt;  3:      1      1        1 lik-acs_filter_container    NA 376228 376228</span></span>
<span><span class="co">#&gt;  4:      1      1        1            lik-pf_lik_ac    NA 374838 374838</span></span>
<span><span class="co">#&gt;  5:      1      1        1            lik-pf_lik_dc    NA      1      1</span></span>
<span><span class="co">#&gt;  6:      1      1        1            sample-origin     1    100      1</span></span>
<span><span class="co">#&gt;  7:      1      1        2                 proposal     1    100    100</span></span>
<span><span class="co">#&gt;  8:      1      1        2      lik-acs_filter_land     1    100    100</span></span>
<span><span class="co">#&gt;  9:      1      1        2 lik-acs_filter_container     1    100    100</span></span>
<span><span class="co">#&gt; 10:      1      1        2            lik-pf_lik_ac     1    100    100</span></span>
<span><span class="co">#&gt; 11:      1      1        2            lik-pf_lik_dc     1      0      0</span></span>
<span><span class="co">#&gt; 12:      1      1        2              sample-kick     1      0      0</span></span>
<span><span class="co">#&gt; 13:      1      2        2                 proposal     1    100     99</span></span>
<span><span class="co">#&gt; 14:      1      2        2      lik-acs_filter_land     1    100     99</span></span>
<span><span class="co">#&gt; 15:      1      2        2 lik-acs_filter_container     1    100     99</span></span>
<span><span class="co">#&gt; 16:      1      2        2            lik-pf_lik_ac     1    100     99</span></span>
<span><span class="co">#&gt; 17:      1      2        2            lik-pf_lik_dc     1      0      0</span></span>
<span><span class="co">#&gt; 18:      1      2        2              sample-kick     1      0      0</span></span>
<span><span class="co">#&gt; 19:      1      3        2                 proposal     1    100    100</span></span>
<span><span class="co">#&gt; 20:      1      3        2      lik-acs_filter_land     1    100    100</span></span>
<span><span class="co">#&gt; 21:      1      3        2 lik-acs_filter_container     1    100    100</span></span>
<span><span class="co">#&gt; 22:      1      3        2            lik-pf_lik_ac     1    100    100</span></span>
<span><span class="co">#&gt; 23:      1      3        2            lik-pf_lik_dc     1      0      0</span></span>
<span><span class="co">#&gt; 24:      1      3        2              sample-kick     1      0      0</span></span>
<span><span class="co">#&gt; 25:      1      4        2                 proposal     1    100    100</span></span>
<span><span class="co">#&gt; 26:      1      4        2      lik-acs_filter_land     1    100    100</span></span>
<span><span class="co">#&gt; 27:      1      4        2 lik-acs_filter_container     1    100    100</span></span>
<span><span class="co">#&gt; 28:      1      4        2            lik-pf_lik_ac     1    100    100</span></span>
<span><span class="co">#&gt; 29:      1      4        2            lik-pf_lik_dc     1      0      0</span></span>
<span><span class="co">#&gt; 30:      1      4        2              sample-kick     1      0      0</span></span>
<span><span class="co">#&gt; 31:      1      5        2                 proposal     1    100    100</span></span>
<span><span class="co">#&gt; 32:      1      5        2      lik-acs_filter_land     1    100    100</span></span>
<span><span class="co">#&gt; 33:      1      5        2 lik-acs_filter_container     1    100    100</span></span>
<span><span class="co">#&gt; 34:      1      5        2            lik-pf_lik_ac     1    100    100</span></span>
<span><span class="co">#&gt; 35:      1      5        2            lik-pf_lik_dc     1      0      0</span></span>
<span><span class="co">#&gt; 36:      1      5        2              sample-kick     1      0      0</span></span>
<span><span class="co">#&gt; 37:      1      6        2                 proposal     1    100     99</span></span>
<span><span class="co">#&gt; 38:      1      6        2      lik-acs_filter_land     1    100     99</span></span>
<span><span class="co">#&gt; 39:      1      6        2 lik-acs_filter_container     1    100     99</span></span>
<span><span class="co">#&gt; 40:      1      6        2            lik-pf_lik_ac     1    100     99</span></span>
<span><span class="co">#&gt; 41:      1      6        2            lik-pf_lik_dc     1      0      0</span></span>
<span><span class="co">#&gt; 42:      1      6        2              sample-kick     1      0      0</span></span>
<span><span class="co">#&gt; 43:      1      7        2                 proposal     1    100    100</span></span>
<span><span class="co">#&gt; 44:      1      7        2      lik-acs_filter_land     1    100    100</span></span>
<span><span class="co">#&gt; 45:      1      7        2 lik-acs_filter_container     1    100    100</span></span>
<span><span class="co">#&gt; 46:      1      7        2            lik-pf_lik_ac     1    100    100</span></span>
<span><span class="co">#&gt; 47:      1      7        2            lik-pf_lik_dc     1      0      0</span></span>
<span><span class="co">#&gt; 48:      1      7        2              sample-kick     1      0      0</span></span>
<span><span class="co">#&gt; 49:      1      8        2                 proposal     1    100    100</span></span>
<span><span class="co">#&gt; 50:      1      8        2      lik-acs_filter_land     1    100    100</span></span>
<span><span class="co">#&gt; 51:      1      8        2 lik-acs_filter_container     1    100    100</span></span>
<span><span class="co">#&gt; 52:      1      8        2            lik-pf_lik_ac     1    100    100</span></span>
<span><span class="co">#&gt; 53:      1      8        2            lik-pf_lik_dc     1      0      0</span></span>
<span><span class="co">#&gt; 54:      1      8        2              sample-kick     1      0      0</span></span>
<span><span class="co">#&gt; 55:      1      9        2                 proposal     1    100    100</span></span>
<span><span class="co">#&gt; 56:      1      9        2      lik-acs_filter_land     1    100    100</span></span>
<span><span class="co">#&gt; 57:      1      9        2 lik-acs_filter_container     1    100    100</span></span>
<span><span class="co">#&gt; 58:      1      9        2            lik-pf_lik_ac     1    100    100</span></span>
<span><span class="co">#&gt; 59:      1      9        2            lik-pf_lik_dc     1      0      0</span></span>
<span><span class="co">#&gt; 60:      1      9        2              sample-kick     1      0      0</span></span>
<span><span class="co">#&gt; 61:      1     10        2                 proposal     1    100    100</span></span>
<span><span class="co">#&gt; 62:      1     10        2      lik-acs_filter_land     1    100    100</span></span>
<span><span class="co">#&gt; 63:      1     10        2 lik-acs_filter_container     1    100    100</span></span>
<span><span class="co">#&gt; 64:      1     10        2            lik-pf_lik_ac     1    100    100</span></span>
<span><span class="co">#&gt; 65:      1     10        2            lik-pf_lik_dc     1      0      0</span></span>
<span><span class="co">#&gt; 66:      1     10        2              sample-kick     1      0      0</span></span>
<span><span class="co">#&gt; 67:      1     11        2                 proposal     1    100    100</span></span>
<span><span class="co">#&gt; 68:      1     11        2      lik-acs_filter_land     1    100    100</span></span>
<span><span class="co">#&gt; 69:      1     11        2 lik-acs_filter_container     1    100    100</span></span>
<span><span class="co">#&gt; 70:      1     11        2            lik-pf_lik_ac     1    100    100</span></span>
<span><span class="co">#&gt; 71:      1     11        2            lik-pf_lik_dc     1      0      0</span></span>
<span><span class="co">#&gt; 72:      1     11        2              sample-kick     1      0      0</span></span>
<span><span class="co">#&gt;     iter_m iter_i timestep                component trial      n    n_u</span></span>
<span><span class="co">#&gt;              ess</span></span>
<span><span class="co">#&gt;  1: 2.657963e-06</span></span>
<span><span class="co">#&gt;  2: 2.657963e-06</span></span>
<span><span class="co">#&gt;  3: 2.657963e-06</span></span>
<span><span class="co">#&gt;  4: 2.267795e-04</span></span>
<span><span class="co">#&gt;  5: 1.025050e+04</span></span>
<span><span class="co">#&gt;  6: 1.025050e+02</span></span>
<span><span class="co">#&gt;  7: 1.000000e-02</span></span>
<span><span class="co">#&gt;  8: 1.000000e-02</span></span>
<span><span class="co">#&gt;  9: 1.000000e-02</span></span>
<span><span class="co">#&gt; 10: 1.987208e-02</span></span>
<span><span class="co">#&gt; 11: 0.000000e+00</span></span>
<span><span class="co">#&gt; 12: 0.000000e+00</span></span>
<span><span class="co">#&gt; 13: 1.000000e-02</span></span>
<span><span class="co">#&gt; 14: 1.000000e-02</span></span>
<span><span class="co">#&gt; 15: 1.000000e-02</span></span>
<span><span class="co">#&gt; 16: 2.103114e-02</span></span>
<span><span class="co">#&gt; 17: 0.000000e+00</span></span>
<span><span class="co">#&gt; 18: 0.000000e+00</span></span>
<span><span class="co">#&gt; 19: 1.000000e-02</span></span>
<span><span class="co">#&gt; 20: 1.000000e-02</span></span>
<span><span class="co">#&gt; 21: 1.000000e-02</span></span>
<span><span class="co">#&gt; 22: 2.259873e-02</span></span>
<span><span class="co">#&gt; 23: 0.000000e+00</span></span>
<span><span class="co">#&gt; 24: 0.000000e+00</span></span>
<span><span class="co">#&gt; 25: 1.000000e-02</span></span>
<span><span class="co">#&gt; 26: 1.000000e-02</span></span>
<span><span class="co">#&gt; 27: 1.000000e-02</span></span>
<span><span class="co">#&gt; 28: 1.908143e-02</span></span>
<span><span class="co">#&gt; 29: 0.000000e+00</span></span>
<span><span class="co">#&gt; 30: 0.000000e+00</span></span>
<span><span class="co">#&gt; 31: 1.000000e-02</span></span>
<span><span class="co">#&gt; 32: 1.000000e-02</span></span>
<span><span class="co">#&gt; 33: 1.000000e-02</span></span>
<span><span class="co">#&gt; 34: 2.311731e-02</span></span>
<span><span class="co">#&gt; 35: 0.000000e+00</span></span>
<span><span class="co">#&gt; 36: 0.000000e+00</span></span>
<span><span class="co">#&gt; 37: 1.000000e-02</span></span>
<span><span class="co">#&gt; 38: 1.000000e-02</span></span>
<span><span class="co">#&gt; 39: 1.000000e-02</span></span>
<span><span class="co">#&gt; 40: 2.218930e-02</span></span>
<span><span class="co">#&gt; 41: 0.000000e+00</span></span>
<span><span class="co">#&gt; 42: 0.000000e+00</span></span>
<span><span class="co">#&gt; 43: 1.000000e-02</span></span>
<span><span class="co">#&gt; 44: 1.000000e-02</span></span>
<span><span class="co">#&gt; 45: 1.000000e-02</span></span>
<span><span class="co">#&gt; 46: 2.279124e-02</span></span>
<span><span class="co">#&gt; 47: 0.000000e+00</span></span>
<span><span class="co">#&gt; 48: 0.000000e+00</span></span>
<span><span class="co">#&gt; 49: 1.000000e-02</span></span>
<span><span class="co">#&gt; 50: 1.000000e-02</span></span>
<span><span class="co">#&gt; 51: 1.000000e-02</span></span>
<span><span class="co">#&gt; 52: 2.066756e-02</span></span>
<span><span class="co">#&gt; 53: 0.000000e+00</span></span>
<span><span class="co">#&gt; 54: 0.000000e+00</span></span>
<span><span class="co">#&gt; 55: 1.000000e-02</span></span>
<span><span class="co">#&gt; 56: 1.000000e-02</span></span>
<span><span class="co">#&gt; 57: 1.000000e-02</span></span>
<span><span class="co">#&gt; 58: 2.114958e-02</span></span>
<span><span class="co">#&gt; 59: 0.000000e+00</span></span>
<span><span class="co">#&gt; 60: 0.000000e+00</span></span>
<span><span class="co">#&gt; 61: 1.000000e-02</span></span>
<span><span class="co">#&gt; 62: 1.000000e-02</span></span>
<span><span class="co">#&gt; 63: 1.000000e-02</span></span>
<span><span class="co">#&gt; 64: 2.099742e-02</span></span>
<span><span class="co">#&gt; 65: 0.000000e+00</span></span>
<span><span class="co">#&gt; 66: 0.000000e+00</span></span>
<span><span class="co">#&gt; 67: 1.000000e-02</span></span>
<span><span class="co">#&gt; 68: 1.000000e-02</span></span>
<span><span class="co">#&gt; 69: 1.000000e-02</span></span>
<span><span class="co">#&gt; 70: 2.084345e-02</span></span>
<span><span class="co">#&gt; 71: 0.000000e+00</span></span>
<span><span class="co">#&gt; 72: 0.000000e+00</span></span>
<span><span class="co">#&gt;              ess</span></span>
<span></span>
<span><span class="co"># (C) Increase the number of particles to improve convergence</span></span>
<span><span class="co"># &gt; In general, ~1000 particles should be sufficient to represent a</span></span>
<span><span class="co"># &gt; 2d distribution (even in the gaps between detections).</span></span>
<span><span class="co"># &gt; We can boost this to improve convergence</span></span>
<span><span class="co"># &gt; (but there are better ways to do this).</span></span>
<span><span class="fu"><a href="../reference/sim_helpers.html">ss</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">out_pff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pf_forward.html">pf_forward</a></span><span class="op">(</span>.obs <span class="op">=</span> <span class="va">obs_sbt</span>,</span>
<span>                      .dlist <span class="op">=</span> <span class="va">dlist</span>,</span>
<span>                      .likelihood <span class="op">=</span> <span class="va">pf_lik_acdcpf</span>,</span>
<span>                      <span class="co"># Boost number of particles</span></span>
<span>                      .n <span class="op">=</span> <span class="fl">1e6L</span>,</span>
<span>                      .trial <span class="op">=</span> <span class="fu"><a href="../reference/pf_opt.html">pf_opt_trial</a></span><span class="op">(</span>.trial_sampler <span class="op">=</span> <span class="fl">0L</span>,</span>
<span>                                            .trial_revert_crit <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>,</span>
<span>                      .record <span class="op">=</span> <span class="va">record</span></span>
<span>                      <span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="va">out_pff</span><span class="op">$</span><span class="va">convergence</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># (D) Increase `.trial_kick` to improve convergence</span></span>
<span><span class="fu"><a href="../reference/sim_helpers.html">ss</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">out_pff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pf_forward.html">pf_forward</a></span><span class="op">(</span>.obs <span class="op">=</span> <span class="va">obs_sbt</span>,</span>
<span>                      .dlist <span class="op">=</span> <span class="va">dlist</span>,</span>
<span>                      .likelihood <span class="op">=</span> <span class="va">pf_lik_acdcpf</span>,</span>
<span>                      <span class="co"># Boost number of particles</span></span>
<span>                      .n <span class="op">=</span> <span class="fl">1e4L</span>,</span>
<span>                      .trial <span class="op">=</span> <span class="fu"><a href="../reference/pf_opt.html">pf_opt_trial</a></span><span class="op">(</span>.trial_kick <span class="op">=</span> <span class="fl">100L</span>,</span>
<span>                                            .trial_sampler <span class="op">=</span> <span class="fl">0L</span>,</span>
<span>                                            .trial_revert_crit <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>,</span>
<span>                      .record <span class="op">=</span> <span class="va">record</span></span>
<span>                      <span class="op">)</span></span>
<span><span class="co"># &gt; It takes ~2-50 kick attempts on each time step to achieve convergence</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="va">out_pff</span><span class="op">$</span><span class="va">convergence</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">out_pff</span><span class="op">$</span><span class="va">diagnostics</span>, <span class="fl">50L</span><span class="op">)</span></span>
<span><span class="co">#&gt;     iter_m iter_i timestep                component trial      n    n_u</span></span>
<span><span class="co">#&gt;  1:      1      1        1                 proposal    NA 376228 376228</span></span>
<span><span class="co">#&gt;  2:      1      1        1      lik-acs_filter_land    NA 376228 376228</span></span>
<span><span class="co">#&gt;  3:      1      1        1 lik-acs_filter_container    NA 376228 376228</span></span>
<span><span class="co">#&gt;  4:      1      1        1            lik-pf_lik_ac    NA 374838 374838</span></span>
<span><span class="co">#&gt;  5:      1      1        1            lik-pf_lik_dc    NA      1      1</span></span>
<span><span class="co">#&gt;  6:      1      1        1            sample-origin     1  10000      1</span></span>
<span><span class="co">#&gt;  7:      1      1        2                 proposal     1  10000   9290</span></span>
<span><span class="co">#&gt;  8:      1      1        2      lik-acs_filter_land     1  10000   9290</span></span>
<span><span class="co">#&gt;  9:      1      1        2 lik-acs_filter_container     1  10000   9290</span></span>
<span><span class="co">#&gt; 10:      1      1        2            lik-pf_lik_ac     1  10000   9290</span></span>
<span><span class="co">#&gt; 11:      1      1        2            lik-pf_lik_dc     1      0      0</span></span>
<span><span class="co">#&gt; 12:      1      1        2              sample-kick     1      0      0</span></span>
<span><span class="co">#&gt; 13:      1      1        2                 proposal     2  10000   9326</span></span>
<span><span class="co">#&gt; 14:      1      1        2      lik-acs_filter_land     2  10000   9326</span></span>
<span><span class="co">#&gt; 15:      1      1        2 lik-acs_filter_container     2  10000   9326</span></span>
<span><span class="co">#&gt; 16:      1      1        2            lik-pf_lik_ac     2  10000   9326</span></span>
<span><span class="co">#&gt; 17:      1      1        2            lik-pf_lik_dc     2      0      0</span></span>
<span><span class="co">#&gt; 18:      1      1        2              sample-kick     2      0      0</span></span>
<span><span class="co">#&gt; 19:      1      1        2                 proposal     3  10000   9312</span></span>
<span><span class="co">#&gt; 20:      1      1        2      lik-acs_filter_land     3  10000   9312</span></span>
<span><span class="co">#&gt; 21:      1      1        2 lik-acs_filter_container     3  10000   9312</span></span>
<span><span class="co">#&gt; 22:      1      1        2            lik-pf_lik_ac     3  10000   9312</span></span>
<span><span class="co">#&gt; 23:      1      1        2            lik-pf_lik_dc     3      0      0</span></span>
<span><span class="co">#&gt; 24:      1      1        2              sample-kick     3      0      0</span></span>
<span><span class="co">#&gt; 25:      1      1        2                 proposal     4  10000   9301</span></span>
<span><span class="co">#&gt; 26:      1      1        2      lik-acs_filter_land     4  10000   9301</span></span>
<span><span class="co">#&gt; 27:      1      1        2 lik-acs_filter_container     4  10000   9301</span></span>
<span><span class="co">#&gt; 28:      1      1        2            lik-pf_lik_ac     4  10000   9301</span></span>
<span><span class="co">#&gt; 29:      1      1        2            lik-pf_lik_dc     4      0      0</span></span>
<span><span class="co">#&gt; 30:      1      1        2              sample-kick     4      0      0</span></span>
<span><span class="co">#&gt; 31:      1      1        2                 proposal     5  10000   9300</span></span>
<span><span class="co">#&gt; 32:      1      1        2      lik-acs_filter_land     5  10000   9300</span></span>
<span><span class="co">#&gt; 33:      1      1        2 lik-acs_filter_container     5  10000   9300</span></span>
<span><span class="co">#&gt; 34:      1      1        2            lik-pf_lik_ac     5  10000   9300</span></span>
<span><span class="co">#&gt; 35:      1      1        2            lik-pf_lik_dc     5      1      1</span></span>
<span><span class="co">#&gt; 36:      1      1        2              sample-kick     5  10000      1</span></span>
<span><span class="co">#&gt; 37:      1      1        3                 proposal     1  10000   9309</span></span>
<span><span class="co">#&gt; 38:      1      1        3      lik-acs_filter_land     1  10000   9309</span></span>
<span><span class="co">#&gt; 39:      1      1        3 lik-acs_filter_container     1  10000   9309</span></span>
<span><span class="co">#&gt; 40:      1      1        3            lik-pf_lik_ac     1  10000   9309</span></span>
<span><span class="co">#&gt; 41:      1      1        3            lik-pf_lik_dc     1      0      0</span></span>
<span><span class="co">#&gt; 42:      1      1        3              sample-kick     1      0      0</span></span>
<span><span class="co">#&gt; 43:      1      1        3                 proposal     2  10000   9327</span></span>
<span><span class="co">#&gt; 44:      1      1        3      lik-acs_filter_land     2  10000   9327</span></span>
<span><span class="co">#&gt; 45:      1      1        3 lik-acs_filter_container     2  10000   9327</span></span>
<span><span class="co">#&gt; 46:      1      1        3            lik-pf_lik_ac     2  10000   9327</span></span>
<span><span class="co">#&gt; 47:      1      1        3            lik-pf_lik_dc     2      0      0</span></span>
<span><span class="co">#&gt; 48:      1      1        3              sample-kick     2      0      0</span></span>
<span><span class="co">#&gt; 49:      1      1        3                 proposal     3  10000   9302</span></span>
<span><span class="co">#&gt; 50:      1      1        3      lik-acs_filter_land     3  10000   9302</span></span>
<span><span class="co">#&gt;     iter_m iter_i timestep                component trial      n    n_u</span></span>
<span><span class="co">#&gt;              ess</span></span>
<span><span class="co">#&gt;  1: 2.657963e-06</span></span>
<span><span class="co">#&gt;  2: 2.657963e-06</span></span>
<span><span class="co">#&gt;  3: 2.657963e-06</span></span>
<span><span class="co">#&gt;  4: 2.267795e-04</span></span>
<span><span class="co">#&gt;  5: 1.025050e+04</span></span>
<span><span class="co">#&gt;  6: 1.025050e+00</span></span>
<span><span class="co">#&gt;  7: 1.000000e-04</span></span>
<span><span class="co">#&gt;  8: 1.000000e-04</span></span>
<span><span class="co">#&gt;  9: 1.000000e-04</span></span>
<span><span class="co">#&gt; 10: 2.130297e-04</span></span>
<span><span class="co">#&gt; 11: 0.000000e+00</span></span>
<span><span class="co">#&gt; 12: 0.000000e+00</span></span>
<span><span class="co">#&gt; 13: 1.000000e-04</span></span>
<span><span class="co">#&gt; 14: 1.000000e-04</span></span>
<span><span class="co">#&gt; 15: 1.000000e-04</span></span>
<span><span class="co">#&gt; 16: 2.141540e-04</span></span>
<span><span class="co">#&gt; 17: 0.000000e+00</span></span>
<span><span class="co">#&gt; 18: 0.000000e+00</span></span>
<span><span class="co">#&gt; 19: 1.000000e-04</span></span>
<span><span class="co">#&gt; 20: 1.000000e-04</span></span>
<span><span class="co">#&gt; 21: 1.000000e-04</span></span>
<span><span class="co">#&gt; 22: 2.133685e-04</span></span>
<span><span class="co">#&gt; 23: 0.000000e+00</span></span>
<span><span class="co">#&gt; 24: 0.000000e+00</span></span>
<span><span class="co">#&gt; 25: 1.000000e-04</span></span>
<span><span class="co">#&gt; 26: 1.000000e-04</span></span>
<span><span class="co">#&gt; 27: 1.000000e-04</span></span>
<span><span class="co">#&gt; 28: 2.099835e-04</span></span>
<span><span class="co">#&gt; 29: 0.000000e+00</span></span>
<span><span class="co">#&gt; 30: 0.000000e+00</span></span>
<span><span class="co">#&gt; 31: 1.000000e-04</span></span>
<span><span class="co">#&gt; 32: 1.000000e-04</span></span>
<span><span class="co">#&gt; 33: 1.000000e-04</span></span>
<span><span class="co">#&gt; 34: 2.146203e-04</span></span>
<span><span class="co">#&gt; 35: 1.478627e+00</span></span>
<span><span class="co">#&gt; 36: 1.478627e-04</span></span>
<span><span class="co">#&gt; 37: 1.000000e-04</span></span>
<span><span class="co">#&gt; 38: 1.000000e-04</span></span>
<span><span class="co">#&gt; 39: 1.000000e-04</span></span>
<span><span class="co">#&gt; 40: 1.717859e-04</span></span>
<span><span class="co">#&gt; 41: 0.000000e+00</span></span>
<span><span class="co">#&gt; 42: 0.000000e+00</span></span>
<span><span class="co">#&gt; 43: 1.000000e-04</span></span>
<span><span class="co">#&gt; 44: 1.000000e-04</span></span>
<span><span class="co">#&gt; 45: 1.000000e-04</span></span>
<span><span class="co">#&gt; 46: 1.711044e-04</span></span>
<span><span class="co">#&gt; 47: 0.000000e+00</span></span>
<span><span class="co">#&gt; 48: 0.000000e+00</span></span>
<span><span class="co">#&gt; 49: 1.000000e-04</span></span>
<span><span class="co">#&gt; 50: 1.000000e-04</span></span>
<span><span class="co">#&gt;              ess</span></span>
<span><span class="va">out_pff</span><span class="op">$</span><span class="va">diagnostics</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">timestep</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">trial</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 2</span></span></span>
<span><span class="co">#&gt;    timestep     n</span></span>
<span><span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>        1     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>        2     5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>        3    21</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>        4     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>        5     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>        6     8</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>        7     4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>        8     2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>        9     4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>       10     1</span></span>
<span></span>
<span><span class="co"># (D) Increase `.trial_revert` args to improve convergence</span></span>
<span><span class="co"># &gt; `.trial_revert` forces the  algorithm to revert to an earlier</span></span>
<span><span class="co"># &gt; time step if a convergence failure is identified</span></span>
<span><span class="fu"><a href="../reference/sim_helpers.html">ss</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">out_pff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pf_forward.html">pf_forward</a></span><span class="op">(</span>.obs <span class="op">=</span> <span class="va">obs_sbt</span>,</span>
<span>                      .dlist <span class="op">=</span> <span class="va">dlist</span>,</span>
<span>                      .likelihood <span class="op">=</span> <span class="va">pf_lik_acdcpf</span>,</span>
<span>                      .n <span class="op">=</span> <span class="fl">5e4L</span>,</span>
<span>                      .trial <span class="op">=</span> <span class="fu"><a href="../reference/pf_opt.html">pf_opt_trial</a></span><span class="op">(</span></span>
<span>                        <span class="co"># Use 1 kick per attempt</span></span>
<span>                        .trial_kick <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>                        <span class="co"># Use 10 reverts</span></span>
<span>                        .trial_revert <span class="op">=</span> <span class="fl">10L</span>,</span>
<span>                        <span class="co"># Only revert if &lt; 1 cell identified</span></span>
<span>                        .trial_revert_crit <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>                        <span class="co"># Revert by `.trial_revert_steps` time step</span></span>
<span>                        .trial_revert_steps <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>                        .trial_sampler <span class="op">=</span> <span class="fl">0L</span>,</span>
<span>                      <span class="op">)</span>,</span>
<span>                      .record <span class="op">=</span> <span class="va">record</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Convergence error: there are no particles with positive weights at</span></span>
<span><span class="co">#&gt; time step 9. Returning outputs up to time step 9.</span></span>
<span><span class="co"># This may or may not converge depending on the seed</span></span>
<span><span class="va">out_pff</span><span class="op">$</span><span class="va">convergence</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="va">out_pff</span><span class="op">$</span><span class="va">diagnostics</span></span>
<span><span class="co">#&gt;      iter_m iter_i timestep                component trial      n    n_u</span></span>
<span><span class="co">#&gt;   1:      1      1        1                 proposal    NA 376228 376228</span></span>
<span><span class="co">#&gt;   2:      1      1        1      lik-acs_filter_land    NA 376228 376228</span></span>
<span><span class="co">#&gt;   3:      1      1        1 lik-acs_filter_container    NA 376228 376228</span></span>
<span><span class="co">#&gt;   4:      1      1        1            lik-pf_lik_ac    NA 374838 374838</span></span>
<span><span class="co">#&gt;   5:      1      1        1            lik-pf_lik_dc    NA      1      1</span></span>
<span><span class="co">#&gt;  ---                                                                    </span></span>
<span><span class="co">#&gt; 152:      1     11        9      lik-acs_filter_land     1  50000  35679</span></span>
<span><span class="co">#&gt; 153:      1     11        9 lik-acs_filter_container     1  50000  35679</span></span>
<span><span class="co">#&gt; 154:      1     11        9            lik-pf_lik_ac     1  46685  32809</span></span>
<span><span class="co">#&gt; 155:      1     11        9            lik-pf_lik_dc     1      0      0</span></span>
<span><span class="co">#&gt; 156:      1     11        9              sample-kick     1      0      0</span></span>
<span><span class="co">#&gt;               ess</span></span>
<span><span class="co">#&gt;   1: 2.657963e-06</span></span>
<span><span class="co">#&gt;   2: 2.657963e-06</span></span>
<span><span class="co">#&gt;   3: 2.657963e-06</span></span>
<span><span class="co">#&gt;   4: 2.267795e-04</span></span>
<span><span class="co">#&gt;   5: 1.025050e+04</span></span>
<span><span class="co">#&gt;  ---             </span></span>
<span><span class="co">#&gt; 152: 2.000000e-05</span></span>
<span><span class="co">#&gt; 153: 2.000000e-05</span></span>
<span><span class="co">#&gt; 154: 1.732715e-03</span></span>
<span><span class="co">#&gt; 155: 0.000000e+00</span></span>
<span><span class="co">#&gt; 156: 0.000000e+00</span></span>
<span></span>
<span><span class="co"># (E) Use .rerun to rerun the algorithm from an earlier time step</span></span>
<span><span class="fu"><a href="../reference/sim_helpers.html">ss</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">out_pff_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pf_forward.html">pf_forward</a></span><span class="op">(</span>.obs <span class="op">=</span> <span class="va">obs_sbt</span>,</span>
<span>                      .dlist <span class="op">=</span> <span class="va">dlist</span>,</span>
<span>                      .likelihood <span class="op">=</span> <span class="va">pf_lik_acdcpf</span>,</span>
<span>                      <span class="co"># Retain parameters of the previous run</span></span>
<span>                      .n <span class="op">=</span> <span class="fl">5e4L</span>,</span>
<span>                      .trial <span class="op">=</span> <span class="fu"><a href="../reference/pf_opt.html">pf_opt_trial</a></span><span class="op">(</span></span>
<span>                        .trial_kick <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>                        .trial_revert <span class="op">=</span> <span class="fl">10L</span>,</span>
<span>                        .trial_revert_crit <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>                        .trial_revert_steps <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>                        .trial_sampler <span class="op">=</span> <span class="fl">0L</span>,</span>
<span>                      <span class="op">)</span>,</span>
<span>                      <span class="co"># Rerun from earlier outputs (e.g., t = 3L)</span></span>
<span>                      .rerun <span class="op">=</span> <span class="va">out_pff</span>,</span>
<span>                      .rerun_from <span class="op">=</span> <span class="fl">3L</span>,</span>
<span>                      .record <span class="op">=</span> <span class="va">record</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Convergence error: there are no particles with positive weights at</span></span>
<span><span class="co">#&gt; time step 3. Returning outputs up to time step 3.</span></span>
<span><span class="co"># This helps but does not facilitate convergence in this example</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_false</a></span><span class="op">(</span><span class="va">out_pff_2</span><span class="op">$</span><span class="va">convergence</span><span class="op">)</span></span>
<span><span class="co"># The output contains successful particle samples:</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">out_pff_2</span><span class="op">$</span><span class="va">history</span><span class="op">)</span></span>
<span><span class="co">#&gt;      Length Class      Mode</span></span>
<span><span class="co">#&gt; [1,] 10     data.table list</span></span>
<span><span class="co">#&gt; [2,] 10     data.table list</span></span>
<span><span class="co">#&gt; [3,] 10     data.table list</span></span>
<span><span class="co">#&gt; [4,] 10     data.table list</span></span>
<span><span class="co">#&gt; [5,] 10     data.table list</span></span>
<span><span class="co">#&gt; [6,] 10     data.table list</span></span>
<span><span class="co">#&gt; [7,] 10     data.table list</span></span>
<span><span class="co">#&gt; [8,] 10     data.table list</span></span>
<span><span class="co"># But all diagnostics (from all runs):</span></span>
<span><span class="va">out_pff_2</span><span class="op">$</span><span class="va">diagnostics</span></span>
<span><span class="co">#&gt;      iter_m iter_i timestep                component trial      n    n_u</span></span>
<span><span class="co">#&gt;   1:      1      1        1                 proposal    NA 376228 376228</span></span>
<span><span class="co">#&gt;   2:      1      1        1      lik-acs_filter_land    NA 376228 376228</span></span>
<span><span class="co">#&gt;   3:      1      1        1 lik-acs_filter_container    NA 376228 376228</span></span>
<span><span class="co">#&gt;   4:      1      1        1            lik-pf_lik_ac    NA 374838 374838</span></span>
<span><span class="co">#&gt;   5:      1      1        1            lik-pf_lik_dc    NA      1      1</span></span>
<span><span class="co">#&gt;  ---                                                                    </span></span>
<span><span class="co">#&gt; 266:      2     11        3      lik-acs_filter_land     1  50000  35556</span></span>
<span><span class="co">#&gt; 267:      2     11        3 lik-acs_filter_container     1  50000  35556</span></span>
<span><span class="co">#&gt; 268:      2     11        3            lik-pf_lik_ac     1  50000  35556</span></span>
<span><span class="co">#&gt; 269:      2     11        3            lik-pf_lik_dc     1      0      0</span></span>
<span><span class="co">#&gt; 270:      2     11        3              sample-kick     1      0      0</span></span>
<span><span class="co">#&gt;               ess</span></span>
<span><span class="co">#&gt;   1: 2.657963e-06</span></span>
<span><span class="co">#&gt;   2: 2.657963e-06</span></span>
<span><span class="co">#&gt;   3: 2.657963e-06</span></span>
<span><span class="co">#&gt;   4: 2.267795e-04</span></span>
<span><span class="co">#&gt;   5: 1.025050e+04</span></span>
<span><span class="co">#&gt;  ---             </span></span>
<span><span class="co">#&gt; 266: 2.000000e-05</span></span>
<span><span class="co">#&gt; 267: 2.000000e-05</span></span>
<span><span class="co">#&gt; 268: 3.420417e-05</span></span>
<span><span class="co">#&gt; 269: 0.000000e+00</span></span>
<span><span class="co">#&gt; 270: 0.000000e+00</span></span>
<span><span class="co"># And the complete set of timings:</span></span>
<span><span class="va">out_pff_2</span><span class="op">$</span><span class="va">time</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [[1]]$start</span></span>
<span><span class="co">#&gt; [1] "2023-12-30 11:12:00 GMT"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[1]]$end</span></span>
<span><span class="co">#&gt; [1] "2023-12-30 11:12:02 GMT"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[1]]$duration</span></span>
<span><span class="co">#&gt; Time difference of 2.075424 secs</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [[2]]$start</span></span>
<span><span class="co">#&gt; [1] "2023-12-30 11:12:02 GMT"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]$end</span></span>
<span><span class="co">#&gt; [1] "2023-12-30 11:12:03 GMT"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]$duration</span></span>
<span><span class="co">#&gt; Time difference of 1.232315 secs</span></span>
<span></span>
<span><span class="co">#### (3) ACDCPF forward simulation (default)</span></span>
<span><span class="co"># &gt; The default implementation attempts &lt;=.trial_kick kicks &amp; then uses directed sampling</span></span>
<span><span class="fu"><a href="../reference/sim_helpers.html">ss</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">out_pff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pf_forward.html">pf_forward</a></span><span class="op">(</span>.obs <span class="op">=</span> <span class="va">obs_sbt</span>,</span>
<span>                      .dlist <span class="op">=</span> <span class="va">dlist</span>,</span>
<span>                      .likelihood <span class="op">=</span> <span class="va">pf_lik_acdcpf</span>,</span>
<span>                      .record <span class="op">=</span> <span class="va">record</span>,</span>
<span>                      .control <span class="op">=</span> <span class="fu"><a href="../reference/pf_opt.html">pf_opt_control</a></span><span class="op">(</span>.sampler_batch_size <span class="op">=</span> <span class="fl">100L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Convergence warning: insufficient particles (1 &lt; 5</span></span>
<span><span class="co">#&gt; [`.trial_revert_crit`] particles) at timestep 2.</span></span>
<span><span class="co">#&gt; Warning: Convergence warning: insufficient particles (1 &lt; 5</span></span>
<span><span class="co">#&gt; [`.trial_revert_crit`] particles) at timestep 3.</span></span>
<span><span class="co">#&gt; Warning: Convergence warning: insufficient particles (1 &lt; 5</span></span>
<span><span class="co">#&gt; [`.trial_revert_crit`] particles) at timestep 4.</span></span>
<span><span class="co">#&gt; Warning: Convergence warning: insufficient particles (1 &lt; 5</span></span>
<span><span class="co">#&gt; [`.trial_revert_crit`] particles) at timestep 5.</span></span>
<span><span class="co">#&gt; Warning: Convergence warning: insufficient particles (1 &lt; 5</span></span>
<span><span class="co">#&gt; [`.trial_revert_crit`] particles) at timestep 6.</span></span>
<span><span class="co">#&gt; Warning: Convergence warning: insufficient particles (1 &lt; 5</span></span>
<span><span class="co">#&gt; [`.trial_revert_crit`] particles) at timestep 7.</span></span>
<span><span class="co">#&gt; Warning: Convergence warning: insufficient particles (1 &lt; 5</span></span>
<span><span class="co">#&gt; [`.trial_revert_crit`] particles) at timestep 8.</span></span>
<span><span class="co">#&gt; Warning: Convergence warning: insufficient particles (1 &lt; 5</span></span>
<span><span class="co">#&gt; [`.trial_revert_crit`] particles) at timestep 9.</span></span>
<span><span class="co">#&gt; Warning: Convergence warning: insufficient particles (1 &lt; 5</span></span>
<span><span class="co">#&gt; [`.trial_revert_crit`] particles) at timestep 10.</span></span>
<span><span class="co"># &gt; This converges</span></span>
<span><span class="co"># &gt; But, at each time step, we are wasting effort kicking particles</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="va">out_pff</span><span class="op">$</span><span class="va">convergence</span><span class="op">)</span></span>
<span><span class="va">out_pff</span><span class="op">$</span><span class="va">diagnostics</span></span>
<span><span class="co">#&gt;      iter_m iter_i timestep                component trial      n    n_u</span></span>
<span><span class="co">#&gt;   1:      1      1        1                 proposal    NA 376228 376228</span></span>
<span><span class="co">#&gt;   2:      1      1        1      lik-acs_filter_land    NA 376228 376228</span></span>
<span><span class="co">#&gt;   3:      1      1        1 lik-acs_filter_container    NA 376228 376228</span></span>
<span><span class="co">#&gt;   4:      1      1        1            lik-pf_lik_ac    NA 374838 374838</span></span>
<span><span class="co">#&gt;   5:      1      1        1            lik-pf_lik_dc    NA      1      1</span></span>
<span><span class="co">#&gt;  ---                                                                    </span></span>
<span><span class="co">#&gt; 154:      1     11       10            lik-pf_lik_ac     1    100    100</span></span>
<span><span class="co">#&gt; 155:      1     11       10            lik-pf_lik_dc     1      0      0</span></span>
<span><span class="co">#&gt; 156:      1     11       10              sample-kick     1      0      0</span></span>
<span><span class="co">#&gt; 157:      1     11       10             lik-directed    NA      1      1</span></span>
<span><span class="co">#&gt; 158:      1     11       10          sample-directed     1    100      1</span></span>
<span><span class="co">#&gt;               ess</span></span>
<span><span class="co">#&gt;   1: 2.657963e-06</span></span>
<span><span class="co">#&gt;   2: 2.657963e-06</span></span>
<span><span class="co">#&gt;   3: 2.657963e-06</span></span>
<span><span class="co">#&gt;   4: 2.267795e-04</span></span>
<span><span class="co">#&gt;   5: 1.025050e+04</span></span>
<span><span class="co">#&gt;  ---             </span></span>
<span><span class="co">#&gt; 154: 8.348220e-01</span></span>
<span><span class="co">#&gt; 155: 0.000000e+00</span></span>
<span><span class="co">#&gt; 156: 0.000000e+00</span></span>
<span><span class="co">#&gt; 157: 2.130531e+01</span></span>
<span><span class="co">#&gt; 158: 2.130531e-01</span></span>
<span></span>
<span><span class="co">#### (4) ACDCPF forward simulation (directed sampling)</span></span>
<span><span class="co"># &gt; The diagnostics above suggest we should focus on directed sampling</span></span>
<span><span class="fu"><a href="../reference/sim_helpers.html">ss</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">out_pff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pf_forward.html">pf_forward</a></span><span class="op">(</span>.obs <span class="op">=</span> <span class="va">obs_sbt</span>,</span>
<span>                      .dlist <span class="op">=</span> <span class="va">dlist</span>,</span>
<span>                      .likelihood <span class="op">=</span> <span class="va">pf_lik_acdcpf</span>,</span>
<span>                      .record <span class="op">=</span> <span class="va">record</span>,</span>
<span>                      .trial <span class="op">=</span> <span class="fu"><a href="../reference/pf_opt.html">pf_opt_trial</a></span><span class="op">(</span></span>
<span>                        <span class="co"># Use `.trial_kick` = 0L to suppress kicks</span></span>
<span>                        .trial_kick <span class="op">=</span> <span class="fl">0L</span>,</span>
<span>                        .trial_revert_crit <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>,</span>
<span>                      .control <span class="op">=</span> <span class="fu"><a href="../reference/pf_opt.html">pf_opt_control</a></span><span class="op">(</span>.sampler_batch_size <span class="op">=</span> <span class="fl">100L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="va">out_pff</span><span class="op">$</span><span class="va">convergence</span><span class="op">)</span></span>
<span><span class="va">out_pff</span><span class="op">$</span><span class="va">diagnostics</span></span>
<span><span class="co">#&gt;     iter_m iter_i timestep                component trial      n    n_u</span></span>
<span><span class="co">#&gt;  1:      1      1        1                 proposal    NA 376228 376228</span></span>
<span><span class="co">#&gt;  2:      1      1        1      lik-acs_filter_land    NA 376228 376228</span></span>
<span><span class="co">#&gt;  3:      1      1        1 lik-acs_filter_container    NA 376228 376228</span></span>
<span><span class="co">#&gt;  4:      1      1        1            lik-pf_lik_ac    NA 374838 374838</span></span>
<span><span class="co">#&gt;  5:      1      1        1            lik-pf_lik_dc    NA      1      1</span></span>
<span><span class="co">#&gt;  6:      1      1        1            sample-origin     1    100      1</span></span>
<span><span class="co">#&gt;  7:      1      1        2             lik-directed    NA      1      1</span></span>
<span><span class="co">#&gt;  8:      1      1        2          sample-directed     1    100      1</span></span>
<span><span class="co">#&gt;  9:      1      1        3             lik-directed    NA      1      1</span></span>
<span><span class="co">#&gt; 10:      1      1        3          sample-directed     1    100      1</span></span>
<span><span class="co">#&gt; 11:      1      1        4             lik-directed    NA      1      1</span></span>
<span><span class="co">#&gt; 12:      1      1        4          sample-directed     1    100      1</span></span>
<span><span class="co">#&gt; 13:      1      1        5             lik-directed    NA      1      1</span></span>
<span><span class="co">#&gt; 14:      1      1        5          sample-directed     1    100      1</span></span>
<span><span class="co">#&gt; 15:      1      1        6             lik-directed    NA      1      1</span></span>
<span><span class="co">#&gt; 16:      1      1        6          sample-directed     1    100      1</span></span>
<span><span class="co">#&gt; 17:      1      1        7             lik-directed    NA      1      1</span></span>
<span><span class="co">#&gt; 18:      1      1        7          sample-directed     1    100      1</span></span>
<span><span class="co">#&gt; 19:      1      1        8             lik-directed    NA      1      1</span></span>
<span><span class="co">#&gt; 20:      1      1        8          sample-directed     1    100      1</span></span>
<span><span class="co">#&gt; 21:      1      1        9             lik-directed    NA      1      1</span></span>
<span><span class="co">#&gt; 22:      1      1        9          sample-directed     1    100      1</span></span>
<span><span class="co">#&gt; 23:      1      1       10             lik-directed    NA      1      1</span></span>
<span><span class="co">#&gt; 24:      1      1       10          sample-directed     1    100      1</span></span>
<span><span class="co">#&gt;     iter_m iter_i timestep                component trial      n    n_u</span></span>
<span><span class="co">#&gt;              ess</span></span>
<span><span class="co">#&gt;  1: 2.657963e-06</span></span>
<span><span class="co">#&gt;  2: 2.657963e-06</span></span>
<span><span class="co">#&gt;  3: 2.657963e-06</span></span>
<span><span class="co">#&gt;  4: 2.267795e-04</span></span>
<span><span class="co">#&gt;  5: 1.025050e+04</span></span>
<span><span class="co">#&gt;  6: 1.025050e+02</span></span>
<span><span class="co">#&gt;  7: 1.478627e+00</span></span>
<span><span class="co">#&gt;  8: 1.478627e-02</span></span>
<span><span class="co">#&gt;  9: 3.441188e+00</span></span>
<span><span class="co">#&gt; 10: 3.441188e-02</span></span>
<span><span class="co">#&gt; 11: 1.279025e+02</span></span>
<span><span class="co">#&gt; 12: 1.279025e+00</span></span>
<span><span class="co">#&gt; 13: 8.369997e+00</span></span>
<span><span class="co">#&gt; 14: 8.369997e-02</span></span>
<span><span class="co">#&gt; 15: 5.280784e+01</span></span>
<span><span class="co">#&gt; 16: 5.280784e-01</span></span>
<span><span class="co">#&gt; 17: 2.720493e+00</span></span>
<span><span class="co">#&gt; 18: 2.720493e-02</span></span>
<span><span class="co">#&gt; 19: 2.943560e+03</span></span>
<span><span class="co">#&gt; 20: 2.943560e+01</span></span>
<span><span class="co">#&gt; 21: 5.997423e+01</span></span>
<span><span class="co">#&gt; 22: 5.997423e-01</span></span>
<span><span class="co">#&gt; 23: 2.130531e+01</span></span>
<span><span class="co">#&gt; 24: 2.130531e-01</span></span>
<span><span class="co">#&gt;              ess</span></span>
<span></span>
<span><span class="co">#### (5) Complete forward simulation using directed sampling</span></span>
<span><span class="co"># &gt; Our exploratory analyses indicated directed sampling for this dataset.</span></span>
<span><span class="co"># &gt; So we will implement this approach across the full time series.</span></span>
<span><span class="co"># &gt; This is a fairly unique case where we know with certainty the location @</span></span>
<span><span class="co"># &gt; each time step. In general, the default implementation which exploits</span></span>
<span><span class="co"># &gt; two proposal mechanisms (kicking &amp; direct sampling) is probably preferable.</span></span>
<span></span>
<span><span class="co"># Order likelihood functions efficiently</span></span>
<span><span class="va">pf_lik_acdcpf_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pf_lik_dc <span class="op">=</span> <span class="va">pf_lik_dc</span>,</span>
<span>                        acs_filter_container <span class="op">=</span> <span class="va">acs_filter_container</span>,</span>
<span>                        pf_lik_ac <span class="op">=</span> <span class="va">pf_lik_ac</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run simulation</span></span>
<span><span class="fu"><a href="../reference/sim_helpers.html">ss</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">out_pff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pf_forward.html">pf_forward</a></span><span class="op">(</span>.obs <span class="op">=</span> <span class="va">obs</span>,</span>
<span>                      .dlist <span class="op">=</span> <span class="va">dlist</span>,</span>
<span>                      .likelihood <span class="op">=</span> <span class="va">pf_lik_acdcpf_2</span>,</span>
<span>                      .trial <span class="op">=</span> <span class="fu"><a href="../reference/pf_opt.html">pf_opt_trial</a></span><span class="op">(</span>.trial_kick <span class="op">=</span> <span class="fl">0L</span>,</span>
<span>                                            .trial_revert_crit <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>,</span>
<span>                      .control <span class="op">=</span> <span class="fu"><a href="../reference/pf_opt.html">pf_opt_control</a></span><span class="op">(</span>.sampler_batch_size <span class="op">=</span> <span class="fl">100L</span><span class="op">)</span>,</span>
<span>                      .record <span class="op">=</span> <span class="va">record</span></span>
<span>                      <span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="va">out_pff</span><span class="op">$</span><span class="va">convergence</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="validation">Validation<a class="anchor" aria-label="anchor" href="#validation"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#### Validate output elements</span></span>
<span><span class="co"># Identify path segment between analysed observations</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">path</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">timestamp</span> <span class="op"><a href="https://rdrr.io/pkg/terra/man/match.html" class="external-link">%in%</a></span> <span class="va">obs</span><span class="op">$</span><span class="va">timestamp</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>timestep <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># We have one set of particles for each time step</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="va">path</span><span class="op">$</span><span class="va">timestep</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">out_pff</span><span class="op">$</span><span class="va">history</span>, \<span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="va">d</span><span class="op">$</span><span class="va">timestep</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>             <span class="op">)</span></span>
<span><span class="co"># We have also recorded convergence diagnostics at each time step</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">path</span><span class="op">$</span><span class="va">timestep</span> <span class="op"><a href="https://rdrr.io/pkg/terra/man/match.html" class="external-link">%in%</a></span> <span class="va">out_pff</span><span class="op">$</span><span class="va">diagnostics</span><span class="op">$</span><span class="va">timestep</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#### Validate reconstruction of the correct path</span></span>
<span><span class="co"># Identify particle samples from each time step</span></span>
<span><span class="va">ps</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">out_pff</span><span class="op">$</span><span class="va">history</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">timestep</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>cell_now <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">cell_now</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">timestep</span>, cell_id <span class="op">=</span> <span class="va">cell_now</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Confirm we have sampled the correct location at each time step</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="va">path</span><span class="op">$</span><span class="va">cell_id</span>, <span class="va">ps</span><span class="op">$</span><span class="va">cell_id</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#### Examine maps of space use</span></span>
<span><span class="co"># Build map using path</span></span>
<span><span class="va">pp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">map_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/map_dens.html">map_dens</a></span><span class="op">(</span><span class="va">gebco</span>, .coord <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">path</span><span class="op">$</span><span class="va">x</span>, <span class="va">path</span><span class="op">$</span><span class="va">y</span>, cex <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="co"># Build map using coordinates</span></span>
<span><span class="va">map_particles</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/map_dens.html">map_dens</a></span><span class="op">(</span><span class="va">gebco</span>,</span>
<span>                          .coord <span class="op">=</span> <span class="fu"><a href="../reference/pf_coord.html">pf_coord</a></span><span class="op">(</span><span class="va">out_pff</span><span class="op">$</span><span class="va">history</span>, .bathy <span class="op">=</span> <span class="va">gebco</span><span class="op">)</span>, </span>
<span>                          .plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">path</span><span class="op">$</span><span class="va">x</span>, <span class="va">path</span><span class="op">$</span><span class="va">y</span>, cex <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span></code></pre></div>
<p><img src="d-demos_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">pp</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">map_path</span>, <span class="va">map_particles</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Edward Lavender.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
