<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>PF: pre-calculate densities for the backward pass — pf_backward_dens • patter</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="PF: pre-calculate densities for the backward pass — pf_backward_dens"><meta property="og:description" content="This function is used to pre-calculate densities for the backward pass."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">patter</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/faqs.html">FAQs</a>
    </li>
    <li>
      <a href="../articles/workflow.html">A re-implementation of the `flapper` algorithms</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/edwardlavender/patter/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>PF: pre-calculate densities for the backward pass</h1>
    <small class="dont-index">Source: <a href="https://github.com/edwardlavender/patter/blob/HEAD/R/pf_backward_p.R" class="external-link"><code>R/pf_backward_p.R</code></a></small>
    <div class="hidden name"><code>pf_backward_dens.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This function is used to pre-calculate densities for the backward pass.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">pf_backward_dens</span><span class="op">(</span></span>
<span>  <span class="va">.history</span>,</span>
<span>  <span class="va">.dens_step</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  .in_memory <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  .collect <span class="op">=</span> <span class="fl">1e+09</span>,</span>
<span>  .store <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  .cl <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  .varlist <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  .verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  .txt <span class="op">=</span> <span class="st">""</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>.history</dt>
<dd><p>Particle samples from the forward simulation.</p>
<p>If <code>.in_memory = TRUE</code>, this can be provided as:</p><ul><li><p>A <code>list</code> of <code><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></code>s that define cell samples; i.e., the <code>history</code> element of a <code><a href="pf-class.html">pf</a></code> object.</p></li>
<li><p>An ordered list of file paths (from <code><a href="pf_setup_files.html">pf_setup_files()</a></code>) that define the directories in which particle samples were written from the forward simulation (as parquet files).</p></li>
</ul><p>If <code>.in_memory = FALSE</code>, this must be a character string that defines the directory within which parquet files are stored.</p></dd>


<dt>.dens_step, ...</dt>
<dd><p>A function, and associated arguments, to calculate the density of movements between locations (see <code><a href="pf_backward.html">pf_backward()</a></code> and <code><a href="sim_helpers.html">dstep()</a></code>). This must accept the arguments described in <code><a href="pf_backward.html">pf_backward()</a></code>:</p><ul><li><p><code>.data_now</code>---a <code><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></code> of particle locations;</p></li>
<li><p><code>.data_past</code>---a <code><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></code> of paired particle locations;</p></li>
<li><p>(optional) <code>...</code>---additional arguments;</p></li>
</ul><p>However, note that the exact form of <code>.data_now</code> and <code>.data_past</code> differ depending on the implementation (see Details):</p><ul><li><p>For implementation options (1) and (2A), densities are calculated between all cell pairs (i.e., two multi-row <code><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></code>s), by default via <code><a href="sim_helpers.html">dstep()</a></code>. Internally, this uses <code><a href="https://rdrr.io/pkg/terra/man/distance.html" class="external-link">terra::distance()</a></code> so you must specify <code>lonlat</code> and <code>pairwise = TRUE</code>.</p></li>
<li><p>For implementation option (2B) <code>.data_now</code> is a single row (as described in <code><a href="pf_backward.html">pf_backward()</a></code>). Under the default implementation, <code>lonlat</code> is required but <code>pairwise</code> is optional.</p></li>
</ul><p>For custom functions, note that coordinates are stored in each <code><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></code> in <code>x_now</code> and <code>y_now</code> columns. Other columns are dropped, with some exceptions.</p></dd>


<dt>.in_memory</dt>
<dd><p>A logical variable that defines whether or not to begin processing in memory (see Details).</p></dd>


<dt>.collect</dt>
<dd><p>If <code>.in_memory = FALSE</code>, <code>.collect</code> is an <code>integer</code> that controls whether or not particle pairs are brought into memory for density calculations (see Details). If the number of particle pairs exceeds <code>.collect</code>, processing continues without bringing the data fully into memory.</p></dd>


<dt>.store</dt>
<dd><p>If <code>.in_memory = FALSE</code> and <code>.collect</code> is exceeded, <code>.store</code> is required. This is a character string that defines the path to an empty directory within which to write files.</p></dd>


<dt>.cl, .varlist</dt>
<dd><p>Parallelisation options for implementation 2B (see Details and <code><a href="cl.html">cl_lapply()</a></code>).</p></dd>


<dt>.verbose, .txt</dt>
<dd><p>Arguments to monitor function progress (see <code><a href="pf_forward_1.html">pf_forward_1()</a></code>).</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>The function returns:</p><ul><li><p>Implementations 1 and 2A: a named, nested <code>list</code></p></li>
<li><p>Implementation 2B: <code>invisible(NULL)</code> (see Details)</p></li>
</ul></div>
    <div id="details">
    <h2>Details</h2>
    <p>The backward pass sweeps backwards in time through particle samples to reconstruct movement paths (see <code><a href="pf_backward.html">pf_backward()</a></code>). For each particle, at each time step this algorithm samples a preceding location according to the probability densities connecting that particle to all particles from the preceding time step. The purpose of this function is to identify the set of unique transitions between particle pairs and pre-calculate probability densities for <code><a href="pf_backward.html">pf_backward()</a></code>.</p>
<p>There are five steps:</p><ol><li><p>Identify cells. The first step is to identify set of unique locations (grid cells) sampled (by the forward filter) at each time step.</p></li>
<li><p>Identify transitions. The second step is to reconstruct the set of possible transitions between cells at each time step. This requires a cross-join operation (at each time step, each (unique) cell is paired against all (unique) cells from the previous time step). This is memory intensive and can be optionally implemented using <code>sparklyr</code> (see below).</p></li>
<li><p>Identify distinct transitions. The third step is to identify the set of unique cell combinations for which probability densities are required. This is hopefully considerably fewer less than the total number of transitions.</p></li>
<li><p>Calculate densities. The fourth step is to calculate densities (e.g., via <code><a href="sim_helpers.html">dstep()</a></code>).</p></li>
<li><p>Return outputs. The final step is to return densities in a format that can be efficiently accessed in <code><a href="pf_backward.html">pf_backward()</a></code> (e.g., via <code><a href="pf_backward_p.html">dstep_lookup()</a></code> or <code><a href="pf_backward_p.html">dstep_read()</a></code>).</p></li>
</ol><p>There are three implementation options:</p><ol><li><p><code>.in_memory</code> is <code>TRUE</code>. Under this option, steps 1--5 are implemented in memory. A <code>list</code> is returned that can be accessed in <code><a href="pf_backward.html">pf_backward()</a></code> via <code><a href="pf_backward_p.html">dstep_lookup()</a></code>.</p></li>
<li><p><code>.in_memory</code> is <code>FALSE</code>. Under this option, steps 1--5 are implemented without bringing the data (fully) into memory. Steps 1--3 are achieved using <code>sparklyr</code>. The function establishes a connection to Spark, implements 1--3 using Spark, and counts the resultant number of unique transitions for which densities are required (<code>n</code>). What happens next depends on whether or not <code>n &lt;= .collect</code>:</p><ul><li><p>(A) <code>n &lt;= .collect</code>. If <code>n &lt; .collect</code>, data are brought into memory for steps 4--5. A <code>list</code> is returned that can be accessed in <code><a href="pf_backward.html">pf_backward()</a></code> via <code><a href="pf_backward_p.html">dstep_lookup()</a></code>.</p></li>
<li><p>(B) <code>n &gt; .collect</code>. If <code>n &gt; .collect</code>, steps 4--5 are implemented in batches:</p><ul><li><p>For each grid cell, a parquet file is written to <code>{.store}/pairs/{cell}.parquet</code> with the coordinates of cell pairs;</p></li>
<li><p>Parquet files are iteratively read into memory, density calculations are implemented and, for each grid cell, a <code>list</code> of densities to paired cells is written to <code>{.store}/density/{cell}.qs</code>. This step can be optionally parallelised. Limited experimentation suggested that this approach is faster than a full Spark implementation. The resultant files can be accessed in <code><a href="pf_backward.html">pf_backward()</a></code> via <code><a href="pf_backward_p.html">dstep_read()</a></code>. The function itself returns <code>invisible(NULL)</code>.</p></li>
</ul></li>
</ul></li>
</ol></div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index">
<ul><li><p><code><a href="acs.html">acs()</a></code> and <code><a href="dc.html">dc()</a></code> implement AC-branch algorithms;</p></li>
<li><p><code><a href="pf_forward_1.html">pf_forward_1()</a></code> and <code><a href="pf_forward_2.html">pf_forward_2()</a></code> implement the forward simulation;</p></li>
<li><p><code><a href="pf_backward.html">pf_backward()</a></code> implements the backward pass;</p></li>
<li><p><code><a href="pf_path.html">pf_path()</a></code> reconstructs movement paths;</p></li>
<li><p><code><a href="pf_map_pou.html">pf_map_pou()</a></code> and <code><a href="pf_map_dens.html">pf_map_dens()</a></code> generate maps of space use;</p></li>
<li><p><code><a href="pf_setup_files.html">pf_setup_files()</a></code>, <code><a href="pf_kick.html">pf_kick()</a></code> and <code><a href="pf_coords.html">pf_coords()</a></code> are helper functions;</p></li>
</ul></div>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Edward Lavender</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># See ?`pf_backward()` for examples</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Edward Lavender.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

