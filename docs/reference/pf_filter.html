<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>PF: particle filter — pf_filter • patter</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="PF: particle filter — pf_filter"><meta property="og:description" content="This function runs the particle filter. The filter samples possible states (typically locations, termed particles) of an animal at each time point given the data up to (and including) that time point and a movement model."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">


    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">patter</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/a-methodology.html">Methodology</a>
    </li>
    <li>
      <a href="../articles/b-workflow-outline.html">Workflow outline</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/edwardlavender/patter/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>PF: particle filter</h1>
    <small class="dont-index">Source: <a href="https://github.com/edwardlavender/patter/blob/HEAD/R/particle-filter.R" class="external-link"><code>R/particle-filter.R</code></a></small>
    <div class="hidden name"><code>pf_filter.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This function runs the particle filter. The filter samples possible states (typically locations, termed particles) of an animal at each time point given the data up to (and including) that time point and a movement model.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">pf_filter</span><span class="op">(</span></span>
<span>  <span class="va">.timeline</span>,</span>
<span>  .state <span class="op">=</span> <span class="st">"StateXY"</span>,</span>
<span>  .xinit <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  .model_move <span class="op">=</span> <span class="fu"><a href="ModelMove.html">move_xy</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  .yobs <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  .n_move <span class="op">=</span> <span class="fl">100000L</span>,</span>
<span>  .n_particle <span class="op">=</span> <span class="fl">1000L</span>,</span>
<span>  .n_resample <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">.n_particle</span><span class="op">)</span>,</span>
<span>  .n_record <span class="op">=</span> <span class="fl">1000L</span>,</span>
<span>  .n_iter <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  .direction <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"forward"</span>, <span class="st">"backward"</span><span class="op">)</span>,</span>
<span>  .verbose <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"patter.verbose"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>


<dl><dt id="arg--timeline">.timeline<a class="anchor" aria-label="anchor" href="#arg--timeline"></a></dt>
<dd><p>A <code>POSIXct</code> vector of regularly spaced time stamps that defines the timeline for the simulation. Here, <code>.timeline</code> is used to:</p><ul><li><p>Define the time steps of the simulation;</p></li>
</ul></dd>


<dt id="arg--state-xinit">.state, .xinit<a class="anchor" aria-label="anchor" href="#arg--state-xinit"></a></dt>
<dd><p>Arguments used to simulate initial states.</p><ul><li><p><code>.state</code>—A <code>character</code> that defines the <code><a href="State.html">State</a></code> sub-type;</p></li>
<li><p><code>.xinit</code>—<code>NULL</code> or a <code><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></code> that defines the initial states for the simulation;</p></li>
</ul></dd>


<dt id="arg--model-move-n-move">.model_move, .n_move<a class="anchor" aria-label="anchor" href="#arg--model-move-n-move"></a></dt>
<dd><p>The movement model.</p><ul><li><p><code>.model_move</code>—A <code>character</code> string that defines the movement model (see <code><a href="ModelMove.html">ModelMove</a></code>);</p></li>
<li><p><code>.n_move</code>—An <code>integer</code> that defines the number of attempts to find a legal move;</p></li>
</ul></dd>


<dt id="arg--yobs">.yobs<a class="anchor" aria-label="anchor" href="#arg--yobs"></a></dt>
<dd><ul><li><p><code>.yobs</code> is a named <code>list</code> of formatted datasets, one for each data type (see <code><a href="glossary.html">glossary</a></code>);</p></li>
</ul></dd>


<dt id="arg--n-particle">.n_particle<a class="anchor" aria-label="anchor" href="#arg--n-particle"></a></dt>
<dd><p>An <code>integer</code> that defines the number of particles.</p></dd>


<dt id="arg--n-resample">.n_resample<a class="anchor" aria-label="anchor" href="#arg--n-resample"></a></dt>
<dd><p>A <code>double</code> that defines the effective sample size at which to re-sample particles.</p></dd>


<dt id="arg--n-record">.n_record<a class="anchor" aria-label="anchor" href="#arg--n-record"></a></dt>
<dd><p>An <code>integer</code> that defines the number of recorded particles at each time step.</p></dd>


<dt id="arg--n-iter">.n_iter<a class="anchor" aria-label="anchor" href="#arg--n-iter"></a></dt>
<dd><p>An <code>integer</code> that defines the number of iterations of the filter;</p></dd>


<dt id="arg--direction">.direction<a class="anchor" aria-label="anchor" href="#arg--direction"></a></dt>
<dd><p>A <code>character</code> string that defines the direction of the filter:</p><ul><li><p><code>"forward"</code> runs the filter from <code>.timeline[1]:.timeline[length(.timeline)]</code>;</p></li>
<li><p><code>"backward"</code> runs the filter from <code>.timeline[length(.timeline)]:.timeline[1]</code>;</p></li>
</ul></dd>


<dt id="arg--verbose">.verbose<a class="anchor" aria-label="anchor" href="#arg--verbose"></a></dt>
<dd><p>User output control (see <code><a href="patter-progress.html">patter-progress</a></code> for supported options).</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p>The function returns a <code><a href="pf_particles-class.html">pf_particles</a></code> object.</p>
    </div>
    <div id="overview">
    <h2>Overview</h2>
    <p>The particle filter iterates over time steps, simulating states (termed 'particles') that are consistent with the preceding data and a movement model at each time step.</p>
<p>A raster map of study area must be exported to <code>Julia</code> for this function (see <code><a href="julia_set.html">set_map()</a></code>.</p>
<p>The initial states for the algorithm are defined by <code>.xinit</code> or simulated via <a href="https://github.com/edwardlavender/Patter.jl" class="external-link"><code>Patter.simulate_states_init()</code></a>. The word 'state' typically means location but may include additional parameters. If the initial state of the animal is known, it should be supplied via <code>.xinit</code>. Otherwise, <a href="https://github.com/edwardlavender/Patter.jl" class="external-link"><code>Patter.simulate_states_init()</code></a> samples <code>.n_particle</code> initial coordinates from <code>.map</code> (via <a href="https://github.com/edwardlavender/Patter.jl" class="external-link"><code>Patter.coords_init()</code></a>), which are then translated into a <code>DataFrame</code> of states (that is, <code>.xinit</code>, via <a href="https://github.com/edwardlavender/Patter.jl" class="external-link"><code>Patter.states_init()</code></a>). The regions on the map from which initial coordinates are sampled can be restricted by the observations (<code>.yobs</code>) and other parameters. For automated handling of custom states and observation models at this stage, custom <code>Patter.map_init</code> and <code>Patter.states_init</code> methods are required (see the Details for <a href="https://github.com/edwardlavender/Patter.jl" class="external-link"><code>Patter.simulate_states_init()</code></a>).</p>
<p>The filter comprises three stages:</p><ol><li><p>A movement step, in which we simulate possible states (particles) for the individual (for time steps 2, ..., T).</p></li>
<li><p>A weights step, in which we calculate particle weights from the log-likelihood of the data at each particle.</p></li>
<li><p>A re-sampling step, in which we optionally re-sample valid states using the weights.</p></li>
</ol><p>The time complexity of the algorithm is \(O(TN)\).</p>
<p>The filter is implemented by the <code>Julia</code> function <a href="https://github.com/edwardlavender/Patter.jl" class="external-link"><code>Patter.particle_filter()</code></a>. To multi-thread movement and likelihood evaluations, set the number of threads via <code><a href="julia_connect.html">julia_connect()</a></code>. See <a href="https://github.com/edwardlavender/Patter.jl" class="external-link"><code>Patter.particle_filter()</code></a> or <code>JuliaCall::julia_help("particle_filter")</code> for further information.</p>
    </div>
    <div id="algorithms">
    <h2>Algorithms</h2>
    <p>This is highly flexible routine for the reconstruction of the possible locations of an individual through time, given the data up to that time point. By modifying the observation models, it is straightforward to implement the ACPF, DCPF and ACDCPF algorithms introduced by Lavender et al. (2023) for reconstructing animal movements in passive acoustic telemetry systems using (a) acoustic time series, (b) archival time series and (c) acoustic and archival time series. <code>pf_filter()</code> thus replaces (and enhances) the <a href="https://edwardlavender.github.io/flapper/reference/ac.html" class="external-link"><code><a href="https://edwardlavender.github.io/flapper/reference/ac.html" class="external-link">flapper::ac()</a></code></a>, <a href="https://edwardlavender.github.io/flapper/reference/dc.html" class="external-link"><code><a href="https://edwardlavender.github.io/flapper/reference/dc.html" class="external-link">flapper::dc()</a></code></a>, <a href="https://edwardlavender.github.io/flapper/reference/acdc.html" class="external-link"><code><a href="https://edwardlavender.github.io/flapper/reference/acdc.html" class="external-link">flapper::acdc()</a></code></a> and <a href="https://edwardlavender.github.io/flapper/reference/pf.html" class="external-link"><code><a href="https://edwardlavender.github.io/flapper/reference/pf.html" class="external-link">flapper::pf()</a></code></a> functions.</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p>Particle filters and smoothers sample states (particles) that represent the possible locations of an individual through time, accounting for all data and the individual's movement.</p><ul><li><p>To simulate artificial datasets, see <code>sim_*()</code> functions (especially <code><a href="sim_path_walk.html">sim_path_walk()</a></code>, <code><a href="sim_array.html">sim_array()</a></code> and <code><a href="sim_observations.html">sim_observations()</a></code>).</p></li>
<li><p>To assemble real-world datasets for the filter, see <code><a href="assemble.html">assemble</a></code><code>_*()</code> functions.</p></li>
<li><p><code>pf_filter()</code> runs the filter:</p><ul><li><p>For state types, see <code><a href="State.html">State</a></code>;</p></li>
<li><p>For observation models, see <code><a href="ModelObs.html">ModelObs</a></code>;</p></li>
<li><p>For movement models, see <code><a href="ModelMove.html">ModelMove</a></code>;</p></li>
</ul></li>
<li><p>To run particle smoothing, use <code><a href="pf_smoother_two_filter.html">pf_smoother_two_filter()</a></code>.</p></li>
<li><p>To map emergent patterns of space use, use a <code>map_*()</code> function (such as <code><a href="map_pou.html">map_pou()</a></code>, <code><a href="map_dens.html">map_dens()</a></code> and <code><a href="map_hr.html">map_hr()</a></code>).</p></li>
</ul></div>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Edward Lavender</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dtplyr.tidyverse.org" class="external-link">dtplyr</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Julia set up</span></span></span>
<span class="r-in"><span><span class="fu"><a href="julia_connect.html">julia_connect</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::julia_connect()` called @ 2024-10-03 16:20:45... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Running `Julia` setup via `JuliaCall::julia_setup()`... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Validating Julia installation... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Setting up Julia project... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... Handling dependencies... </span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>`JULIA_NUM_THREADS` could not be set via `.threads`.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... `Julia` set up with 11 thread(s). </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::julia_connect()` call ended @ 2024-10-03 16:20:51 (duration: ~6 sec(s)). </span>
<span class="r-in"><span><span class="fu"><a href="julia_set.html">set_seed</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Define study period</span></span></span>
<span class="r-in"><span><span class="co"># The resolution of the timeline defines the resolution of the simulation</span></span></span>
<span class="r-in"><span><span class="va">timeline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="st">"2016-01-01"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                length.out <span class="op">=</span> <span class="fl">100L</span>, by <span class="op">=</span> <span class="st">"2 mins"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Define study area</span></span></span>
<span class="r-in"><span><span class="co"># `map` is a SpatRaster that defines the region within which movements are permitted</span></span></span>
<span class="r-in"><span><span class="co"># Here, we consider the movements of an aquatic animal in Scotland</span></span></span>
<span class="r-in"><span><span class="co"># ... `map` represents the bathymetry in the relevant region</span></span></span>
<span class="r-in"><span><span class="co"># Use `set_map()` to export the map to `Julia`</span></span></span>
<span class="r-in"><span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="datasets-mefs.html">dat_gebco</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">map</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="pf_filter-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu"><a href="julia_set.html">set_map</a></span><span class="op">(</span><span class="va">map</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### --------------------------------------------------</span></span></span>
<span class="r-in"><span><span class="co">#### Simulation-based workflow</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Scenario</span></span></span>
<span class="r-in"><span><span class="co"># We have studied the movements of flapper skate off the west coast of Scotland.</span></span></span>
<span class="r-in"><span><span class="co"># We have collected acoustic detections at receivers and depth time series.</span></span></span>
<span class="r-in"><span><span class="co"># Here, we simulate movements and acoustic/archival observations arising from movements.</span></span></span>
<span class="r-in"><span><span class="co"># We then apply particle filtering to the 'observations' to reconstruct</span></span></span>
<span class="r-in"><span><span class="co"># ... simulated movements.</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Simulate an acoustic array</span></span></span>
<span class="r-in"><span><span class="va">moorings</span> <span class="op">&lt;-</span> <span class="fu"><a href="sim_array.html">sim_array</a></span><span class="op">(</span>.map <span class="op">=</span> <span class="va">map</span>,</span></span>
<span class="r-in"><span>                      .timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                      .n_receiver <span class="op">=</span> <span class="fl">100L</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="pf_filter-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># `moorings` includes the following default observation model parameters</span></span></span>
<span class="r-in"><span><span class="co"># * These describe how detection probability declines with distance from a receiver</span></span></span>
<span class="r-in"><span><span class="co"># * These are the parameters of the `ModelObsAcousticLogisTrunc` observation model</span></span></span>
<span class="r-in"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="va">moorings</span><span class="op">$</span><span class="va">receiver_alpha</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">b</span> <span class="op">&lt;-</span> <span class="va">moorings</span><span class="op">$</span><span class="va">receiver_beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="va">moorings</span><span class="op">$</span><span class="va">receiver_gamma</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1000</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">d</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;=</span> <span class="va">g</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">a</span> <span class="op">*</span> <span class="va">b</span> <span class="op">*</span> <span class="va">d</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>     ylab <span class="op">=</span> <span class="st">"Detection probability"</span>,</span></span>
<span class="r-in"><span>     xlab <span class="op">=</span> <span class="st">"Distance (m)"</span>,</span></span>
<span class="r-in"><span>     type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="pf_filter-3.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Simulate a movement path</span></span></span>
<span class="r-in"><span><span class="co"># Define `State` sub-type</span></span></span>
<span class="r-in"><span><span class="co"># &gt; We will consider the animal's movement in two-dimensions (x, y)</span></span></span>
<span class="r-in"><span><span class="va">state</span>    <span class="op">&lt;-</span> <span class="st">"StateXY"</span></span></span>
<span class="r-in"><span><span class="co"># Define the maximum moveable distance (m) between two time steps</span></span></span>
<span class="r-in"><span><span class="va">mobility</span> <span class="op">&lt;-</span> <span class="fl">750</span></span></span>
<span class="r-in"><span><span class="co"># Define the movement model</span></span></span>
<span class="r-in"><span><span class="co"># &gt; We consider a two-dimensional random walk</span></span></span>
<span class="r-in"><span><span class="va">model_move</span> <span class="op">&lt;-</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="ModelMove.html">move_xy</a></span><span class="op">(</span>mobility   <span class="op">=</span> <span class="st">"750.0"</span>,</span></span>
<span class="r-in"><span>          dbn_length <span class="op">=</span> <span class="st">"truncated(Gamma(1, 250.0), upper = 750.0)"</span>,</span></span>
<span class="r-in"><span>          dbn_angle  <span class="op">=</span> <span class="st">"Uniform(-pi, pi)"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Simulate a path</span></span></span>
<span class="r-in"><span><span class="va">paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="sim_path_walk.html">sim_path_walk</a></span><span class="op">(</span>.map <span class="op">=</span> <span class="va">map</span>,</span></span>
<span class="r-in"><span>                       .timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                       .state <span class="op">=</span> <span class="va">state</span>,</span></span>
<span class="r-in"><span>                       .model_move <span class="op">=</span> <span class="va">model_move</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="pf_filter-4.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Simulate observations</span></span></span>
<span class="r-in"><span><span class="co"># Define observation model(s)</span></span></span>
<span class="r-in"><span><span class="co"># * We simulate acoustic observations and depth time series</span></span></span>
<span class="r-in"><span><span class="co"># * Acoustic observations are simulated according to `ModelObsAcousticLogisTrunc`</span></span></span>
<span class="r-in"><span><span class="co"># * Depth observations are simulated according to `ModelObsDepthUniform`</span></span></span>
<span class="r-in"><span><span class="co"># Define a `list` of parameters for the observation models</span></span></span>
<span class="r-in"><span><span class="co"># (See `?ModelObs` for details)</span></span></span>
<span class="r-in"><span><span class="va">pars_1</span> <span class="op">&lt;-</span></span></span>
<span class="r-in"><span>  <span class="va">moorings</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>sensor_id <span class="op">=</span> <span class="st">"receiver_id"</span>, <span class="st">"receiver_x"</span>, <span class="st">"receiver_y"</span>,</span></span>
<span class="r-in"><span>         <span class="st">"receiver_alpha"</span>, <span class="st">"receiver_beta"</span>, <span class="st">"receiver_gamma"</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">pars_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>sensor_id <span class="op">=</span> <span class="fl">1L</span>,</span></span>
<span class="r-in"><span>                     depth_shallow_eps <span class="op">=</span> <span class="fl">10</span>,</span></span>
<span class="r-in"><span>                     depth_deep_eps <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">model_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ModelObsAcousticLogisTrunc <span class="op">=</span> <span class="va">pars_1</span>,</span></span>
<span class="r-in"><span>                  ModelObsDepthUniform <span class="op">=</span> <span class="va">pars_2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Simulate observational datasets</span></span></span>
<span class="r-in"><span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="sim_observations.html">sim_observations</a></span><span class="op">(</span>.timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                        .model_obs <span class="op">=</span> <span class="va">model_obs</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                            Length Class  Mode</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ModelObsAcousticLogisTrunc 1      -none- list</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ModelObsDepthUniform       1      -none- list</span>
<span class="r-in"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">obs</span><span class="op">$</span><span class="va">ModelObsAcousticLogisTrunc</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     timestamp   obs sensor_id receiver_x receiver_y receiver_alpha</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        &lt;POSc&gt; &lt;int&gt;     &lt;int&gt;      &lt;num&gt;      &lt;num&gt;          &lt;num&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1: 2016-01-01     0         1   709142.1    6266607              4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2: 2016-01-01     0         2   698042.1    6267507              4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3: 2016-01-01     0         3   708442.1    6266307              4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4: 2016-01-01     0         4   709942.1    6255107              4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5: 2016-01-01     0         5   701642.1    6265107              4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6: 2016-01-01     0         6   704442.1    6262807              4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    receiver_beta receiver_gamma</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>            &lt;num&gt;          &lt;num&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1:         -0.01            750</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2:         -0.01            750</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3:         -0.01            750</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4:         -0.01            750</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5:         -0.01            750</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6:         -0.01            750</span>
<span class="r-in"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">obs</span><span class="op">$</span><span class="va">ModelObsDepthUniform</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              timestamp      obs sensor_id depth_shallow_eps depth_deep_eps</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 &lt;POSc&gt;    &lt;num&gt;     &lt;int&gt;             &lt;num&gt;          &lt;num&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1: 2016-01-01 00:00:00 28.61550         1                10             10</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2: 2016-01-01 00:02:00 48.68611         1                10             10</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3: 2016-01-01 00:04:00 46.70739         1                10             10</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4: 2016-01-01 00:06:00 49.39752         1                10             10</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5: 2016-01-01 00:08:00 44.18232         1                10             10</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6: 2016-01-01 00:10:00 38.48716         1                10             10</span>
<span class="r-in"><span><span class="co"># Identify detections</span></span></span>
<span class="r-in"><span><span class="va">detections</span> <span class="op">&lt;-</span></span></span>
<span class="r-in"><span>  <span class="va">obs</span><span class="op">$</span><span class="va">ModelObsAcousticLogisTrunc</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">obs</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Collate datasets for filter</span></span></span>
<span class="r-in"><span><span class="co"># &gt; This requires a list of datasets, one for each data type</span></span></span>
<span class="r-in"><span><span class="va">yobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ModelObsAcousticLogisTrunc <span class="op">=</span> <span class="va">obs</span><span class="op">$</span><span class="va">ModelObsAcousticLogisTrunc</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span></span>
<span class="r-in"><span>             ModelObsDepthUniform <span class="op">=</span> <span class="va">obs</span><span class="op">$</span><span class="va">ModelObsDepthUniform</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Example (1): Run the filter using the default options</span></span></span>
<span class="r-in"><span><span class="va">fwd</span> <span class="op">&lt;-</span> <span class="fu">pf_filter</span><span class="op">(</span>.timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                 .state <span class="op">=</span> <span class="va">state</span>,</span></span>
<span class="r-in"><span>                 .xinit <span class="op">=</span> <span class="cn">NULL</span>,</span></span>
<span class="r-in"><span>                 .model_move <span class="op">=</span> <span class="va">model_move</span>,</span></span>
<span class="r-in"><span>                 .yobs <span class="op">=</span> <span class="va">yobs</span>,</span></span>
<span class="r-in"><span>                 .n_particle <span class="op">=</span> <span class="fl">1e4L</span>,</span></span>
<span class="r-in"><span>                 .direction <span class="op">=</span> <span class="st">"forward"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` called @ 2024-10-03 16:20:52... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` called @ 2024-10-03 16:20:52... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:52: Simulating initial states... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:52: Setting observations... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` call ended @ 2024-10-03 16:20:52 (duration: ~0 sec(s)). </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:52: Running filter... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:52: Collating outputs... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` call ended @ 2024-10-03 16:20:52 (duration: ~0 sec(s)). </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Output object structure:</span></span></span>
<span class="r-in"><span><span class="co"># The function returns a `pf_particles` list:</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">fwd</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "list"         "pf_particles"</span>
<span class="r-in"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fwd</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             Length Class      Mode   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> states      6      data.table list   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> diagnostics 4      data.table list   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> convergence 1      -none-     logical</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> trials      1      -none-     numeric</span>
<span class="r-in"><span><span class="co"># `xinit` is a `data.table` of initial particles</span></span></span>
<span class="r-in"><span><span class="va">fwd</span><span class="op">$</span><span class="va">xinit</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> NULL</span>
<span class="r-in"><span><span class="co"># `states` is a `data.table` of particles:</span></span></span>
<span class="r-in"><span><span class="va">fwd</span><span class="op">$</span><span class="va">states</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         path_id timestep           timestamp map_value        x       y</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>           &lt;int&gt;    &lt;int&gt;              &lt;POSc&gt;     &lt;num&gt;    &lt;num&gt;   &lt;num&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      1:       1        1 2016-01-01 00:00:00  28.15271 701392.1 6253557</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      2:       1        2 2016-01-01 00:02:00  44.99290 706653.7 6254981</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      3:       1        3 2016-01-01 00:04:00  36.83118 711529.4 6259975</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      4:       1        4 2016-01-01 00:06:00  53.40397 710741.9 6259442</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      5:       1        5 2016-01-01 00:08:00  51.03339 711312.7 6259241</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ---                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  99996:    1000       96 2016-01-01 03:10:00  28.89696 711620.8 6261960</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  99997:    1000       97 2016-01-01 03:12:00  25.68826 711149.2 6261671</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  99998:    1000       98 2016-01-01 03:14:00  23.04382 710780.9 6261688</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  99999:    1000       99 2016-01-01 03:16:00  24.04741 710873.4 6261640</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 100000:    1000      100 2016-01-01 03:18:00  29.52719 710373.3 6261465</span>
<span class="r-in"><span><span class="co"># `diagnostics` is a `data.table` of filter diagnostics</span></span></span>
<span class="r-in"><span><span class="va">fwd</span><span class="op">$</span><span class="va">diagnostics</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      timestep           timestamp        ess     maxlp</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         &lt;int&gt;              &lt;POSc&gt;      &lt;num&gt;     &lt;num&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   1:        1 2016-01-01 00:00:00 1804.74380 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   2:        2 2016-01-01 00:02:00  876.82376 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   3:        3 2016-01-01 00:04:00   56.65517 -3.189065</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   4:        4 2016-01-01 00:06:00 1134.93019 -3.017632</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   5:        5 2016-01-01 00:08:00 6941.75515 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   6:        6 2016-01-01 00:10:00 2436.87986 -3.145283</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   7:        7 2016-01-01 00:12:00 7664.81316 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   8:        8 2016-01-01 00:14:00 6589.99921 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   9:        9 2016-01-01 00:16:00 7834.29594 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  10:       10 2016-01-01 00:18:00 7853.79450 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  11:       11 2016-01-01 00:20:00 7355.86860 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  12:       12 2016-01-01 00:22:00 7428.89369 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  13:       13 2016-01-01 00:24:00 6543.79516 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  14:       14 2016-01-01 00:26:00 7353.81609 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  15:       15 2016-01-01 00:28:00 1675.70311 -3.111694</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  16:       16 2016-01-01 00:30:00  182.87369 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  17:       17 2016-01-01 00:32:00 3756.03668 -3.015078</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  18:       18 2016-01-01 00:34:00 6106.44362 -3.014798</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  19:       19 2016-01-01 00:36:00 2983.25057 -3.014501</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  20:       20 2016-01-01 00:38:00 7048.02074 -3.014361</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  21:       21 2016-01-01 00:40:00 6597.91690 -3.014733</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  22:       22 2016-01-01 00:42:00 6741.53812 -3.014217</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  23:       23 2016-01-01 00:44:00 6461.36157 -3.014703</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  24:       24 2016-01-01 00:46:00  780.55447 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  25:       25 2016-01-01 00:48:00 6394.08583 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  26:       26 2016-01-01 00:50:00 1844.36581 -3.016407</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  27:       27 2016-01-01 00:52:00 5038.59630 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  28:       28 2016-01-01 00:54:00 4955.62710 -3.015370</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  29:       29 2016-01-01 00:56:00 1619.49136 -3.085649</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  30:       30 2016-01-01 00:58:00 5557.49295 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  31:       31 2016-01-01 01:00:00 1516.23375 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  32:       32 2016-01-01 01:02:00 7934.09894 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  33:       33 2016-01-01 01:04:00 2929.60247 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  34:       34 2016-01-01 01:06:00 7586.02440 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  35:       35 2016-01-01 01:08:00 7895.94415 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  36:       36 2016-01-01 01:10:00 1703.98000 -3.021242</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  37:       37 2016-01-01 01:12:00 1027.59406 -3.106501</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  38:       38 2016-01-01 01:14:00 5813.30240 -3.106430</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  39:       39 2016-01-01 01:16:00 7074.91654 -3.105728</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  40:       40 2016-01-01 01:18:00 7098.25532 -3.105652</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  41:       41 2016-01-01 01:20:00 2780.58635 -3.535751</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  42:       42 2016-01-01 01:22:00 3200.38103 -3.116999</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  43:       43 2016-01-01 01:24:00 4801.83748 -3.114467</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  44:       44 2016-01-01 01:26:00 7349.24954 -3.113891</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  45:       45 2016-01-01 01:28:00 2450.17660 -3.111232</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  46:       46 2016-01-01 01:30:00 3781.76856 -3.114498</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  47:       47 2016-01-01 01:32:00 5078.68993 -3.535616</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  48:       48 2016-01-01 01:34:00 3378.41891 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  49:       49 2016-01-01 01:36:00 2546.38630 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  50:       50 2016-01-01 01:38:00 6855.09042 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  51:       51 2016-01-01 01:40:00 5886.05961 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  52:       52 2016-01-01 01:42:00  420.34656 -3.542577</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  53:       53 2016-01-01 01:44:00 6292.27874 -3.535690</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  54:       54 2016-01-01 01:46:00 7024.54792 -3.535816</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  55:       55 2016-01-01 01:48:00 2100.53485 -3.115090</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  56:       56 2016-01-01 01:50:00 1805.13356 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  57:       57 2016-01-01 01:52:00 3285.98580 -3.249258</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  58:       58 2016-01-01 01:54:00 1112.98451 -3.166520</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  59:       59 2016-01-01 01:56:00 2903.97195 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  60:       60 2016-01-01 01:58:00 8655.50939 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  61:       61 2016-01-01 02:00:00 9067.76334 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  62:       62 2016-01-01 02:02:00 1465.57447 -3.467252</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  63:       63 2016-01-01 02:04:00 8425.34371 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  64:       64 2016-01-01 02:06:00 8728.28453 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  65:       65 2016-01-01 02:08:00 9069.75349 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  66:       66 2016-01-01 02:10:00 9194.10015 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  67:       67 2016-01-01 02:12:00 9293.07693 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  68:       68 2016-01-01 02:14:00 9468.63047 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  69:       69 2016-01-01 02:16:00 9323.44302 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  70:       70 2016-01-01 02:18:00 9532.32713 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  71:       71 2016-01-01 02:20:00 7338.83596 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  72:       72 2016-01-01 02:22:00 8986.47027 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  73:       73 2016-01-01 02:24:00 9590.87255 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  74:       74 2016-01-01 02:26:00 9578.26366 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  75:       75 2016-01-01 02:28:00 5652.59430 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  76:       76 2016-01-01 02:30:00 9309.74324 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  77:       77 2016-01-01 02:32:00 9321.40220 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  78:       78 2016-01-01 02:34:00 9392.70793 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  79:       79 2016-01-01 02:36:00 7541.09776 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  80:       80 2016-01-01 02:38:00 8977.56222 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  81:       81 2016-01-01 02:40:00 8177.97085 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  82:       82 2016-01-01 02:42:00 3465.03600 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  83:       83 2016-01-01 02:44:00 9055.09349 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  84:       84 2016-01-01 02:46:00 9687.17813 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  85:       85 2016-01-01 02:48:00 4870.06371 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  86:       86 2016-01-01 02:50:00 8246.19134 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  87:       87 2016-01-01 02:52:00 9212.71161 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  88:       88 2016-01-01 02:54:00 8476.27870 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  89:       89 2016-01-01 02:56:00 9587.22949 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  90:       90 2016-01-01 02:58:00 9597.50313 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  91:       91 2016-01-01 03:00:00 9295.77734 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  92:       92 2016-01-01 03:02:00 9475.35713 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  93:       93 2016-01-01 03:04:00 9557.38627 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  94:       94 2016-01-01 03:06:00 9307.85979 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  95:       95 2016-01-01 03:08:00 6589.73679 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  96:       96 2016-01-01 03:10:00  527.67106 -3.022276</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  97:       97 2016-01-01 03:12:00 4397.71340 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  98:       98 2016-01-01 03:14:00 8472.05374 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  99:       99 2016-01-01 03:16:00 8878.55554 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 100:      100 2016-01-01 03:18:00 7392.98811 -2.995732</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      timestep           timestamp        ess     maxlp</span>
<span class="r-in"><span><span class="co"># fwd$convergence is a Boolean that defines whether or not the algorithm converged</span></span></span>
<span class="r-in"><span><span class="va">fwd</span><span class="op">$</span><span class="va">convergence</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
<span class="r-in"><span><span class="co"># fwd$trials is an integer that defines the number of trials</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Map output states:</span></span></span>
<span class="r-in"><span><span class="co"># Map particle coordinates</span></span></span>
<span class="r-in"><span><span class="fu"><a href="pf_plot_xy.html">pf_plot_xy</a></span><span class="op">(</span>.map <span class="op">=</span> <span class="va">map</span>, .coord <span class="op">=</span> <span class="va">fwd</span><span class="op">$</span><span class="va">states</span>, .steps <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="pf_filter-5.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co"># Map a utilisation distribution</span></span></span>
<span class="r-in"><span><span class="co"># * Use sigma = spatstat.explore::bw.diggle() for CV bandwidth estimate</span></span></span>
<span class="r-in"><span><span class="fu"><a href="map_dens.html">map_dens</a></span><span class="op">(</span>.map <span class="op">=</span> <span class="va">map</span>,</span></span>
<span class="r-in"><span>         .coord <span class="op">=</span> <span class="va">fwd</span><span class="op">$</span><span class="va">states</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::map_dens()` called @ 2024-10-03 16:20:52... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:52: Processing `.map`... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:52: Building XYM... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:53: Defining `ppp` object... </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Observation window is gridded.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>18 points were rejected as lying outside the specified window</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:53: Estimating density surface... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:53: Scaling density surface... </span>
<span class="r-plt img"><img src="pf_filter-6.png" alt="" width="700" height="433"></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::map_dens()` call ended @ 2024-10-03 16:20:53 (duration: ~1 sec(s)). </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $x</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Marked planar point pattern: 90660 points</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> marks are numeric, of storage type  ‘double’</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> window: binary image mask</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 264 x 190 pixel array (ny, nx)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> enclosing rectangle: [695492.1, 714492.1] x [6246657, 6273057] units</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> *** 18 illegal points stored in attr(,“rejects”) ***</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $D</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> real-valued pixel image</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 264 x 190 pixel array (ny, nx)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> enclosing rectangle: [695490, 714490] x [6246700, 6273100] units</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $ud</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> class       : SpatRaster </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> dimensions  : 264, 190, 1  (nrow, ncol, nlyr)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> resolution  : 100, 100  (x, y)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> extent      : 695492.1, 714492.1, 6246657, 6273057  (xmin, xmax, ymin, ymax)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> coord. ref. : WGS 84 / UTM zone 29N (EPSG:32629) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> source(s)   : memory</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> name        :        lyr.1 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> min value   : 4.984175e-07 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> max value   : 6.042919e-04 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Analyse filter diagnostics</span></span></span>
<span class="r-in"><span><span class="co"># `maxlp` is the maximum log-posterior at each time step</span></span></span>
<span class="r-in"><span><span class="co"># &gt; exp(fwd$diagnostics$maxlp) = the highest likelihood score at each time step (0-1)</span></span></span>
<span class="r-in"><span><span class="co"># &gt; This should not be too low!</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fwd</span><span class="op">$</span><span class="va">diagnostics</span><span class="op">$</span><span class="va">timestamp</span>, <span class="va">fwd</span><span class="op">$</span><span class="va">diagnostics</span><span class="op">$</span><span class="va">maxlp</span>, type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="pf_filter-7.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co"># `ess` is the effective sample size</span></span></span>
<span class="r-in"><span><span class="co"># &gt; For a 2D distribution,  &gt;= 500 particles at each time step should be sufficient</span></span></span>
<span class="r-in"><span><span class="co"># &gt; But we often have a low ESS at the moment of a detection</span></span></span>
<span class="r-in"><span><span class="co"># &gt; If this is too low, we can trying boosting `.n_particle`</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fwd</span><span class="op">$</span><span class="va">diagnostics</span><span class="op">$</span><span class="va">timestamp</span>, <span class="va">fwd</span><span class="op">$</span><span class="va">diagnostics</span><span class="op">$</span><span class="va">ess</span>, type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">detections</span><span class="op">$</span><span class="va">timestamp</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">detections</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>       pch <span class="op">=</span> <span class="fl">21</span>, col <span class="op">=</span> <span class="st">"red"</span>, bg <span class="op">=</span> <span class="st">"red"</span>, cex <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">500</span>, col <span class="op">=</span> <span class="st">"royalblue"</span>, lty <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="pf_filter-8.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Example (2): Customise initial states for the filter</span></span></span>
<span class="r-in"><span><span class="co"># Option (A): Mark the known starting location on `.map`</span></span></span>
<span class="r-in"><span><span class="co"># &gt; Initial states are automatically sampled from `.map`</span></span></span>
<span class="r-in"><span><span class="co"># &gt; We have to reset the initial map in Julia</span></span></span>
<span class="r-in"><span><span class="co"># &gt; Use set_map with .as_Raster = TRUE and .as_GeoArray = FALSE</span></span></span>
<span class="r-in"><span><span class="co"># &gt; (After the example, we reset the map for later examples)</span></span></span>
<span class="r-in"><span><span class="va">origin</span>       <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/setValues.html" class="external-link">setValues</a></span><span class="op">(</span><span class="va">map</span>, <span class="cn">NA</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">cell</span>         <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/xyCellFrom.html" class="external-link">cellFromXY</a></span><span class="op">(</span><span class="va">map</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">paths</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">origin</span><span class="op">[</span><span class="va">cell</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">paths</span><span class="op">$</span><span class="va">map_value</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="fu"><a href="julia_set.html">set_map</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="va">origin</span>, .as_Raster <span class="op">=</span> <span class="cn">TRUE</span>, .as_GeoArray <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fwd</span> <span class="op">&lt;-</span> <span class="fu">pf_filter</span><span class="op">(</span>.timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                 .state <span class="op">=</span> <span class="va">state</span>,</span></span>
<span class="r-in"><span>                 .xinit <span class="op">=</span> <span class="cn">NULL</span>,</span></span>
<span class="r-in"><span>                 .yobs <span class="op">=</span> <span class="va">yobs</span>,</span></span>
<span class="r-in"><span>                 .model_move <span class="op">=</span> <span class="va">model_move</span>,</span></span>
<span class="r-in"><span>                 .n_particle <span class="op">=</span> <span class="fl">1e4L</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` called @ 2024-10-03 16:20:53... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` called @ 2024-10-03 16:20:53... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:53: Simulating initial states... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:53: Setting observations... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` call ended @ 2024-10-03 16:20:53 (duration: ~0 sec(s)). </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:53: Running filter... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:54: Collating outputs... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` call ended @ 2024-10-03 16:20:54 (duration: ~1 sec(s)). </span>
<span class="r-in"><span><span class="fu"><a href="julia_set.html">set_map</a></span><span class="op">(</span><span class="va">map</span>, .as_Raster <span class="op">=</span> <span class="cn">TRUE</span>, .as_GeoArray <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Option (B): Specify `.xinit` manually</span></span></span>
<span class="r-in"><span><span class="co"># &gt; `.xinit` is resampled, as required, to generate `.n_particle` initial states</span></span></span>
<span class="r-in"><span><span class="va">xinit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>map_value <span class="op">=</span> <span class="va">paths</span><span class="op">$</span><span class="va">map_value</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, x <span class="op">=</span> <span class="va">paths</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">paths</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fwd</span>   <span class="op">&lt;-</span> <span class="fu">pf_filter</span><span class="op">(</span>.timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                   .state <span class="op">=</span> <span class="va">state</span>,</span></span>
<span class="r-in"><span>                   .xinit <span class="op">=</span> <span class="va">xinit</span>,</span></span>
<span class="r-in"><span>                   .yobs <span class="op">=</span> <span class="va">yobs</span>,</span></span>
<span class="r-in"><span>                   .model_move <span class="op">=</span> <span class="va">model_move</span>,</span></span>
<span class="r-in"><span>                   .n_particle <span class="op">=</span> <span class="fl">1e4L</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` called @ 2024-10-03 16:20:54... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` called @ 2024-10-03 16:20:54... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:54: Simulating initial states... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:54: Setting observations... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` call ended @ 2024-10-03 16:20:54 (duration: ~0 sec(s)). </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:54: Running filter... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:54: Collating outputs... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` call ended @ 2024-10-03 16:20:54 (duration: ~0 sec(s)). </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Example (3): Customise selected settings</span></span></span>
<span class="r-in"><span><span class="co"># Boost the number of particles</span></span></span>
<span class="r-in"><span><span class="va">fwd</span>   <span class="op">&lt;-</span> <span class="fu">pf_filter</span><span class="op">(</span>.timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                   .state <span class="op">=</span> <span class="va">state</span>,</span></span>
<span class="r-in"><span>                   .xinit <span class="op">=</span> <span class="va">xinit</span>,</span></span>
<span class="r-in"><span>                   .yobs <span class="op">=</span> <span class="va">yobs</span>,</span></span>
<span class="r-in"><span>                   .model_move <span class="op">=</span> <span class="va">model_move</span>,</span></span>
<span class="r-in"><span>                   .n_particle <span class="op">=</span> <span class="fl">1e5L</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` called @ 2024-10-03 16:20:54... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` called @ 2024-10-03 16:20:54... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:54: Simulating initial states... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:54: Setting observations... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` call ended @ 2024-10-03 16:20:54 (duration: ~0 sec(s)). </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:54: Running filter... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:57: Collating outputs... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` call ended @ 2024-10-03 16:20:57 (duration: ~3 sec(s)). </span>
<span class="r-in"><span><span class="co"># Change the threshold ESS for resampling</span></span></span>
<span class="r-in"><span><span class="va">fwd</span>   <span class="op">&lt;-</span> <span class="fu">pf_filter</span><span class="op">(</span>.timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                   .state <span class="op">=</span> <span class="va">state</span>,</span></span>
<span class="r-in"><span>                   .xinit <span class="op">=</span> <span class="va">xinit</span>,</span></span>
<span class="r-in"><span>                   .yobs <span class="op">=</span> <span class="va">yobs</span>,</span></span>
<span class="r-in"><span>                   .model_move <span class="op">=</span> <span class="va">model_move</span>,</span></span>
<span class="r-in"><span>                   .n_particle <span class="op">=</span> <span class="fl">1e5L</span>,</span></span>
<span class="r-in"><span>                   .n_resample <span class="op">=</span> <span class="fl">1000L</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` called @ 2024-10-03 16:20:57... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` called @ 2024-10-03 16:20:57... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:57: Simulating initial states... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:57: Setting observations... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` call ended @ 2024-10-03 16:20:57 (duration: ~0 sec(s)). </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:57: Running filter... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:59: Collating outputs... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` call ended @ 2024-10-03 16:20:59 (duration: ~2 sec(s)). </span>
<span class="r-in"><span><span class="co"># Change the number of particles retained in memory</span></span></span>
<span class="r-in"><span><span class="va">fwd</span>   <span class="op">&lt;-</span> <span class="fu">pf_filter</span><span class="op">(</span>.timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                   .state <span class="op">=</span> <span class="va">state</span>,</span></span>
<span class="r-in"><span>                   .xinit <span class="op">=</span> <span class="va">xinit</span>,</span></span>
<span class="r-in"><span>                   .yobs <span class="op">=</span> <span class="va">yobs</span>,</span></span>
<span class="r-in"><span>                   .model_move <span class="op">=</span> <span class="va">model_move</span>,</span></span>
<span class="r-in"><span>                   .n_particle <span class="op">=</span> <span class="fl">1e5L</span>,</span></span>
<span class="r-in"><span>                   .n_record <span class="op">=</span> <span class="fl">2000L</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` called @ 2024-10-03 16:20:59... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` called @ 2024-10-03 16:20:59... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:59: Simulating initial states... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:59: Setting observations... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` call ended @ 2024-10-03 16:20:59 (duration: ~0 sec(s)). </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:20:59: Running filter... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:21:01: Collating outputs... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` call ended @ 2024-10-03 16:21:01 (duration: ~2 sec(s)). </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Example (2): Run the filter backwards</span></span></span>
<span class="r-in"><span><span class="co"># (A forward and backward run is required for the two-filter smoother)</span></span></span>
<span class="r-in"><span><span class="va">fwd</span> <span class="op">&lt;-</span> <span class="fu">pf_filter</span><span class="op">(</span>.timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                 .state <span class="op">=</span> <span class="va">state</span>,</span></span>
<span class="r-in"><span>                 .xinit <span class="op">=</span> <span class="cn">NULL</span>,</span></span>
<span class="r-in"><span>                 .yobs <span class="op">=</span> <span class="va">yobs</span>,</span></span>
<span class="r-in"><span>                 .model_move <span class="op">=</span> <span class="va">model_move</span>,</span></span>
<span class="r-in"><span>                 .n_particle <span class="op">=</span> <span class="fl">1e4L</span>,</span></span>
<span class="r-in"><span>                 .direction <span class="op">=</span> <span class="st">"backward"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` called @ 2024-10-03 16:21:01... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` called @ 2024-10-03 16:21:01... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:21:01: Simulating initial states... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:21:02: Setting observations... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` call ended @ 2024-10-03 16:21:02 (duration: ~1 sec(s)). </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:21:02: Running filter... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:21:02: Collating outputs... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` call ended @ 2024-10-03 16:21:02 (duration: ~1 sec(s)). </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### --------------------------------------------------</span></span></span>
<span class="r-in"><span><span class="co">#### Real-world examples</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Assemble datasets</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Define datasets for a selected animal</span></span></span>
<span class="r-in"><span><span class="co"># &gt; Here, we consider detections and depth time series from an example flapper skate</span></span></span>
<span class="r-in"><span><span class="va">individual_id</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span></span>
<span class="r-in"><span><span class="va">acc</span> <span class="op">&lt;-</span> <span class="va">dat_acoustics</span><span class="op">[</span><span class="va">individual_id</span> <span class="op">==</span> <span class="fl">25L</span>, <span class="op">]</span><span class="op">[</span>, <span class="va">individual_id</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">arc</span> <span class="op">&lt;-</span> <span class="va">dat_archival</span><span class="op">[</span><span class="va">individual_id</span> <span class="op">==</span> <span class="fl">25L</span>, <span class="op">]</span><span class="op">[</span>, <span class="va">individual_id</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Define a timeline</span></span></span>
<span class="r-in"><span><span class="co"># * We can do this manually or use the observations to define a timeline:</span></span></span>
<span class="r-in"><span><span class="va">timeline</span> <span class="op">&lt;-</span> <span class="fu"><a href="assemble.html">assemble_timeline</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">acc</span>, <span class="va">arc</span><span class="op">)</span>, .step <span class="op">=</span> <span class="st">"2 mins"</span>, .trim <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">timeline</span> <span class="op">&lt;-</span> <span class="va">timeline</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">1440</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">timeline</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "2016-03-17 01:50:00 UTC" "2016-03-19 01:48:00 UTC"</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Assemble a timeline of acoustic observations (0, 1) and model parameters</span></span></span>
<span class="r-in"><span><span class="co"># * The default acoustic observation model parameters are taken from `.moorings`</span></span></span>
<span class="r-in"><span><span class="va">acoustics</span> <span class="op">&lt;-</span> <span class="fu"><a href="assemble.html">assemble_acoustics</a></span><span class="op">(</span>.timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                                .acoustics <span class="op">=</span> <span class="va">acc</span>,</span></span>
<span class="r-in"><span>                                .moorings <span class="op">=</span> <span class="va">dat_moorings</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Assemble a timeline of archival observations and model parameters</span></span></span>
<span class="r-in"><span><span class="co"># * Here, we include model parameters for `ModelObsDepthNormalTrunc`</span></span></span>
<span class="r-in"><span><span class="va">archival</span> <span class="op">&lt;-</span> <span class="fu"><a href="assemble.html">assemble_archival</a></span><span class="op">(</span>.timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                              .archival <span class="op">=</span></span></span>
<span class="r-in"><span>                                <span class="va">arc</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>                                <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>obs <span class="op">=</span> <span class="va">depth</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>                                <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>depth_sigma <span class="op">=</span> <span class="fl">50</span>,</span></span>
<span class="r-in"><span>                                       depth_deep_eps <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Define the .yobs list</span></span></span>
<span class="r-in"><span><span class="va">yobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ModelObsAcousticLogisTrunc <span class="op">=</span> <span class="va">acoustics</span>,</span></span>
<span class="r-in"><span>             ModelObsDepthNormalTrunc <span class="op">=</span> <span class="va">archival</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Visualise realisations of the movement model (the prior)</span></span></span>
<span class="r-in"><span><span class="co"># We will use the same movement model as in previous examples</span></span></span>
<span class="r-in"><span><span class="fu"><a href="sim_path_walk.html">sim_path_walk</a></span><span class="op">(</span>.map <span class="op">=</span> <span class="va">map</span>,</span></span>
<span class="r-in"><span>              .timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>              .state <span class="op">=</span> <span class="va">state</span>,</span></span>
<span class="r-in"><span>              .model_move <span class="op">=</span> <span class="va">model_move</span>,</span></span>
<span class="r-in"><span>              .n_path <span class="op">=</span> <span class="fl">10L</span>, .one_page <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="pf_filter-9.png" alt="" width="700" height="433"></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       path_id timestep           timestamp map_value        x       y</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         &lt;int&gt;    &lt;int&gt;              &lt;POSc&gt;     &lt;num&gt;    &lt;num&gt;   &lt;num&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    1:       1        1 2016-03-17 01:50:00  48.59683 702692.1 6266257</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    2:       1        2 2016-03-17 01:52:00  60.93561 702670.3 6266664</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    3:       1        3 2016-03-17 01:54:00  88.27195 702486.7 6267338</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    4:       1        4 2016-03-17 01:56:00  88.27195 702464.3 6267350</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    5:       1        5 2016-03-17 01:58:00  88.23719 702433.5 6267560</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   ---                                                                </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1436:       1     1436 2016-03-19 01:40:00 155.84995 707093.5 6265169</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1437:       1     1437 2016-03-19 01:42:00 155.84995 707093.6 6265170</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1438:       1     1438 2016-03-19 01:44:00 159.12950 707049.7 6265284</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1439:       1     1439 2016-03-19 01:46:00 158.45581 707209.1 6265234</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1440:       1     1440 2016-03-19 01:48:00 155.84995 707179.9 6265219</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Example (1): Run filter forwards</span></span></span>
<span class="r-in"><span><span class="va">fwd</span> <span class="op">&lt;-</span> <span class="fu">pf_filter</span><span class="op">(</span>.timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                 .state <span class="op">=</span> <span class="va">state</span>,</span></span>
<span class="r-in"><span>                 .yobs <span class="op">=</span> <span class="va">yobs</span>,</span></span>
<span class="r-in"><span>                 .model_move <span class="op">=</span> <span class="va">model_move</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` called @ 2024-10-03 16:21:02... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` called @ 2024-10-03 16:21:02... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:21:02: Simulating initial states... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:21:03: Setting observations... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` call ended @ 2024-10-03 16:21:03 (duration: ~1 sec(s)). </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:21:03: Running filter... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:21:03: Collating outputs... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` call ended @ 2024-10-03 16:21:04 (duration: ~2 sec(s)). </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#### Example (2): Run the filter backwards</span></span></span>
<span class="r-in"><span><span class="va">bwd</span> <span class="op">&lt;-</span> <span class="fu">pf_filter</span><span class="op">(</span>.timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                 .state <span class="op">=</span> <span class="va">state</span>,</span></span>
<span class="r-in"><span>                 .yobs <span class="op">=</span> <span class="va">yobs</span>,</span></span>
<span class="r-in"><span>                 .model_move <span class="op">=</span> <span class="va">model_move</span>,</span></span>
<span class="r-in"><span>                 .direction <span class="op">=</span> <span class="st">"backward"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` called @ 2024-10-03 16:21:04... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` called @ 2024-10-03 16:21:04... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:21:04: Simulating initial states... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:21:04: Setting observations... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` call ended @ 2024-10-03 16:21:04 (duration: ~0 sec(s)). </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:21:04: Running filter... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 16:21:04: Collating outputs... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` call ended @ 2024-10-03 16:21:04 (duration: ~0 sec(s)). </span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Edward Lavender.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer></div>






  </body></html>

