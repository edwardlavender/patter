<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>PF: forward simulation — pf_forward • patter</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="PF: forward simulation — pf_forward"><meta property="og:description" content="This function runs the forward simulation, generating samples of the set of possible locations of an animal at each time point given the data up to that time point and a movement model."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">patter</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/a-methodology.html">Methodology</a>
    </li>
    <li>
      <a href="../articles/b-workflow-outline.html">Workflow</a>
    </li>
    <li>
      <a href="../articles/c-workflow-example.html">A revised implementation of the `flapper` algorithms</a>
    </li>
    <li>
      <a href="../articles/d-demos.html">Demos</a>
    </li>
    <li>
      <a href="../articles/e-faqs.html">FAQs</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/edwardlavender/patter/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>PF: forward simulation</h1>
    <small class="dont-index">Source: <a href="https://github.com/edwardlavender/patter/blob/HEAD/R/pf_forward.R" class="external-link"><code>R/pf_forward.R</code></a></small>
    <div class="hidden name"><code>pf_forward.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This function runs the forward simulation, generating samples of the set of possible locations of an animal at each time point given the data up to that time point and a movement model.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">pf_forward</span><span class="op">(</span></span>
<span>  <span class="va">.obs</span>,</span>
<span>  <span class="va">.dlist</span>,</span>
<span>  .rpropose <span class="op">=</span> <span class="va">pf_rpropose_kick</span>,</span>
<span>  .dpropose <span class="op">=</span> <span class="va">pf_dpropose</span>,</span>
<span>  .likelihood <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  .n <span class="op">=</span> <span class="fl">100L</span>,</span>
<span>  .sample <span class="op">=</span> <span class="va">pf_sample_multinomial</span>,</span>
<span>  .trial <span class="op">=</span> <span class="fu"><a href="pf_opt.html">pf_opt_trial</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  .control <span class="op">=</span> <span class="fu"><a href="pf_opt.html">pf_opt_control</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  .rerun <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  .rerun_from <span class="op">=</span> <span class="fu"><a href="pf_opt.html">pf_opt_rerun_from</a></span><span class="op">(</span><span class="va">.rerun</span><span class="op">)</span>,</span>
<span>  .record <span class="op">=</span> <span class="fu"><a href="pf_opt.html">pf_opt_record</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  .verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>.obs</dt>
<dd><p>A <code><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></code> defining the timeline and associated observations, typically from <code><a href="acs_setup_obs.html">acs_setup_obs()</a></code>.</p></dd>


<dt>.dlist</dt>
<dd><p>A <code>named</code> list of data and parameters required propose samples and calculate likelihoods (see <code>pf_setup_data()</code>, <code><a href="pf_lik.html">pf_lik</a></code> and <code><a href="pf_propose.html">pf_propose</a></code>). At a minimum, this function requires <code>.dlist$spatial$bathy</code>. An <code>.dlist$spatial$origin</code> <code><a href="https://rdrr.io/pkg/terra/man/SpatRaster-class.html" class="external-link">SpatRaster</a></code> can be included to define the origin. Additional elements required by <code>.likelihood</code>,<code>.rpropose</code> and <code>.dpropose</code> functions should be included (see below).</p></dd>


<dt>.rpropose, .dpropose</dt>
<dd><p>Proposal functions (see <code><a href="pf_propose.html">pf_propose</a></code>).</p><ul><li><p><code>.rpropose</code> is a function that proposes new locations for the individual, given previous locations. By default, this is a 'stochastic kick' function that simulates new locations by randomly kicking previous particles (see <code><a href="pf_propose.html">pf_rpropose_kick()</a></code> and Details).</p></li>
<li><p><code>.dpropose</code> is a function that evaluates the probability density of movements between location pairs (see <code><a href="pf_propose.html">pf_dpropose</a></code>). This is required for directed sampling (see Details).</p></li>
</ul></dd>


<dt>.likelihood</dt>
<dd><p>A named <code>list</code> of likelihood functions. These are used to calculate the likelihood of each dataset at proposal locations. See <code><a href="pf_lik.html">pf_lik</a></code> for required arguments, convenience functions and advice.</p></dd>


<dt>.n, .sample</dt>
<dd><p>Sampling arguments.</p><ul><li><p><code>.n</code> is an <code>integer</code> that defines the number of particle samples at each time step.</p></li>
<li><p><code>.sample</code> is a function used to (re)-sample proposal locations (see <code><a href="pf_sample.html">pf_sample</a></code>).</p></li>
</ul></dd>


<dt>.trial</dt>
<dd><p>A named <code>list</code> of tuning parameters for convergence, from <code><a href="pf_opt.html">pf_opt_trial()</a></code>.</p></dd>


<dt>.control</dt>
<dd><p>A named <code>list</code> of control options, from <code><a href="pf_opt.html">pf_opt_control()</a></code>.</p></dd>


<dt>.rerun, .rerun_from</dt>
<dd><p>Rerun options. These options are used to restart the algorithm from an earlier time step in the case of a convergence failure.</p><ul><li><p><code>.rerun</code> is the named <code>list</code> of algorithm outputs from a previous rerun.</p></li>
<li><p><code>.rerun_from</code> is an <code>integer</code> that defines the time step from which to rerun the algorithm.</p></li>
</ul><p>Algorithm parameters should remain consistent on algorithm reruns.</p></dd>


<dt>.record</dt>
<dd><p>A named <code>list</code> of output options, from <code><a href="pf_opt.html">pf_opt_record()</a></code>.</p></dd>


<dt>.verbose</dt>
<dd><p>User output control (see <code><a href="patter-progress.html">patter-progress</a></code> for supported options).</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>The function returns a <code><a href="pf_particles-class.html">pf_particles</a></code> object. If <code>.return$sink</code> is specified, two directories, .return$sink/history/ and .return$sink/diagnostics, are also created that contain particle samples and diagnostics. Particle samples are labelled <code>1.parquet, 2.parquet, ..., T.parquet</code>, where <code>T</code> is the number of time steps. Diagnostics are labelled <code>A-B-C</code>, where <code>A</code>, <code>B</code> and <code>C</code> are the number of manual restarts, internal reversions and time steps. Use <code><a href="pf_forward_diagnostics.html">pf_forward_diagnostics()</a></code> to collate diagnostics.</p>
    </div>
    <div id="overview">
    <h2>Overview</h2>
    <p><code>pf_forward()</code> iterates over time steps, simulating location samples (termed 'particles') that are consistent with the preceding data and a movement model at each time step. At each time step, this process comprises four steps:</p><ol><li><p>A proposal step, in which we propose possible locations for the individual.</p></li>
<li><p>A likelihood step, in which we calculate the likelihood of the data given each proposal.</p></li>
<li><p>A weights step, in which we translate likelihoods into sampling weights.</p></li>
<li><p>A sampling step, in which we (re)sample valid proposal locations using the weights.</p></li>
</ol><p>At the first time step, proposal locations are defined from a large number of 'quadrature points' across a <code><a href="https://rdrr.io/pkg/terra/man/SpatRaster-class.html" class="external-link">SpatRaster</a></code> that defines starting location(s), defined in <code>.dlist$spatial$origin</code> (<code>.dlist$spatial$bathy</code> is used if <code>.dlist$spatial$origin</code> is undefined). <code>NA</code>s/non <code>NA</code>s distinguish possible/impossible locations. For AC*PF algorithm implementations, grid cells beyond acoustic containers are masked. For *DCPF implementations, it is also desirable if you can, at least approximately, mask grid cells that are incompatible with the first depth observation. At the first time step, up to <code>1e6</code> locations ('quadrature points') are sampled from the <code><a href="https://rdrr.io/pkg/terra/man/SpatRaster-class.html" class="external-link">SpatRaster</a></code>. At each quadrature point, we evaluate likelihoods and calculate weights. <code>.n</code> starting locations (particles) are sampled from the set of quadrature points using the weights.</p>
<p>At subsequent time steps, proposal locations are generated via <code>.rpropose</code> which, by default, is a 'stochastic kick' function that 'kicks' previous particles at random into new locations (in line the restrictions imposed by a movement model). The benefit of this approach is that it is extremely fast, but in situations in which there are relatively few possible locations for an individual, the approach can work poorly because few kicked particles end up in valid locations. A <code>list</code> of likelihood functions is used to evaluate the likelihood of the data, given each proposal, and filter invalid proposals. During this time, we track how the number and diversity of proposal locations declines, as the data are revealed to be incompatible with selected proposals by successive likelihood functions (see Diagnostics). Likelihoods are translated into weights and <code>.n</code> valid proposals (particles) are resampled, with replacement, using the weights. If the number of unique, valid locations is &lt;= <code>.trial_kick_crit</code>, this process is repeated up to <code>.trial_kick</code> times.</p>
<p>Following the stochastic-kick methodology, if the number of unique, valid locations is &lt;= <code>.trial_sampler_crit</code>, directed sampling is initiated. For each unique, previous location, this methodology identifies the set of reachable cells, given a mobility parameter, and evaluates likelihoods and the probability density of movements into each reachable location (which are used to define sampling weights). <code>.n</code> locations are then directly sampled from the set of valid locations. This approach is expensive in terms of time (since it requires iteration over particles) and memory (since the complete set of valid locations is used for sampling). Particles can be processed in batches for improved speed, up to the limits imposed by available memory (see <code>.control</code>). While this approach is expensive, sampling from the set of valid locations facilitates convergence.</p>
<p>You can opt to use either <code>.rpropose</code> or directed sampling via the <code>.trial_</code> arguments. However, in general, it is advisable to permit the algorithm to chop-and-change between methods, depending on the number of valid proposals. This approach benefits from the speed benefits of stochastic kicks, where possible, as well as the improved convergence properties of directed sampling, where required.</p>
<p>Particle rejuvenation is another strategy that is sometimes used to facilitate convergence but this is not currently implemented.</p>
<p>At the end of each time step, if the number of unique, valid locations remains &lt;= <code>.trial_revert_crit</code>, the algorithm can step backwards in time by <code>.trial_revert_steps</code> and try again. This reversion will be attempted up to <code>.trial_revert</code> times. After <code>.trial_revert</code> times, if the algorithm reaches a time step when there are fewer than <code>.trial_revert_crit</code> unique samples, it will produce a <code><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></code>, but attempt to continue the simulation if possible. In the case of convergence failures, you can rerun the simulation from existing outputs, starting from an earlier time step, via <code>.rerun</code>. However, algorithm arguments should remain constant. On algorithm reversions and reruns, particle samplers are replaced but particle diagnostics are always retained.</p>
<p>The algorithm iterates over the time series, proposing and sampling particles as described above. Particle samples can be saved in memory or written to file, alongside particle diagnostics. If the function fails to convergence, a <code><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></code> is returned alongside the outputs up to that time step. Otherwise, the function will continue to the end of the time series.</p>
    </div>
    <div id="algorithms">
    <h2>Algorithms</h2>
    <p>This is highly flexible routine for the reconstruction of possible locations of an individual through time, given the data up to that time point. By modifying the likelihood functions, it is straightforward to implement the ACPF, DCPF and ACDCPF algorithms introduced by Lavender et al. (2023) for reconstructing movements using (a) acoustic time series, (b) archival time series and (c) acoustic and archival time series.</p>
    </div>
    <div id="convergence-and-diagnostics">
    <h2>Convergence and diagnostics</h2>
    <p>While <code>pf_forward()</code> tries hard to reconstruct a complete time series of location samples, algorithm convergence is not guaranteed. The algorithm may reach a dead-end---a time step at which there are no valid locations into which the algorithm can step. This may be due to data errors, incorrect assumptions, insufficient sampling effort or poor tuning parameter settings. To facilitate diagnosis of the immediate cause of convergence failures, during likelihood evaluations we keep track of 'particle diagnostics', i.e., the number of unique, valid locations before/after each likelihood evaluation alongside other statistics.</p>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Edward Lavender</p>
    </div>

  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Edward Lavender.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

