<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>States — State • patter</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="States — State"><meta property="og:description" content="State is an Abstract Type in Patter.jl that groups state sub-types."><meta property="og:image" content="/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">


    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">patter</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/a-methodology.html">Methodology</a>
    </li>
    <li>
      <a href="../articles/b-workflow-outline.html">Workflow outline</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/edwardlavender/patter/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>States</h1>
    <small class="dont-index">Source: <a href="https://github.com/edwardlavender/patter/blob/HEAD/R/models.R" class="external-link"><code>R/models.R</code></a></small>
    <div class="hidden name"><code>State.Rd</code></div>
    </div>

    <div class="ref-description">
    <p><code>State</code> is an Abstract Type in <a href="https://edwardlavender.github.io/Patter.jl" class="external-link"><code>Patter.jl</code></a> that groups state sub-types.</p>
    </div>


    <div id="details">
    <h2>Details</h2>
    <p><code>State</code> sub-types are <code>Julia</code> structures that hold the parameters that describe the state of an individual at a given time step. 'State' typically means 'location' (in two or three dimensions), but individual states may include additional fields for those state dimensions that depend on the state time step. (For example, in correlated random walks, the <code>State</code> should contain the heading, given that the heading at one time step depends on the previous heading and a turning angle.) From an <code>R</code>-user perspective, you can think of a <code>State</code> sub-type as an <code>S4</code>-<code><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></code>-like object, with slots for the state dimensions.</p>
<p>In <code><a href="patter.html">patter</a></code> functions, the <code>.state</code> argument is a <code>character</code> string that defines the animal's state sub-type. This must match a <code>State</code> sub-type defined in <code>Julia</code>. The built-in options are:</p><ul><li><p><code>"StateXY"</code>, which maps to <code>StateXY</code>;</p></li>
<li><p><code>"StateXYZ"</code>, which maps to <code>StateXYZ</code>;</p></li>
<li><p><code>"StateCXY"</code>, which maps to <code>StateCXY</code> ;</p></li>
<li><p><code>"StateCXYZ"</code>, which maps to <code>StateCXYZ</code>;</p></li>
</ul><p>See <a href="https://edwardlavender.github.io/Patter.jl" class="external-link"><code>State</code></a> or <code>JuliaCall::julia_help("State")</code> for the fields of the built-in sub-types.</p>
<p><code>.state</code> is used by <code><a href="sim_path_walk.html">sim_path_walk()</a></code> and <code><a href="pf_filter.html">pf_filter()</a></code>, both of which effectively simulate time series of states. <code>.state</code> controls the simulation of initial locations and subsequent method dispatch in <a href="https://github.com/edwardlavender/Patter.jl" class="external-link"><code>Patter.jl</code></a>. <a href="https://github.com/edwardlavender/Patter.jl" class="external-link"><code>Patter.sim_states_init()</code></a> handles the simulation of initial states in these routines. When <code>.state</code> is</p><ul><li><p><code>"StateXY"</code>, the initial state comprises <code>x</code> and <code>y</code> coordinates;</p></li>
<li><p><code>"StateXYZ"</code>, the initial state comprises <code>x</code>, <code>y</code> and <code>z</code> coordinates;</p></li>
<li><p><code>"StateCXY"</code>, the initial state comprises <code>x</code> and <code>y</code> coordinates and an initial heading;</p></li>
<li><p><code>"StateCXYZ"</code>, the initial states comprises <code>x</code>, <code>y</code> and <code>z</code> coordinates and an initial heading;</p></li>
</ul><p>All states additionally include a <code>map_value</code> field that defines the value on the movement map at (<code>x</code>, <code>y</code>).</p>
<p>The outcome of <a href="https://github.com/edwardlavender/Patter.jl" class="external-link"><code>Patter.sim_states_init()</code></a> is a <code>DataFrame</code> of initial state(s), which is coerced to a <code>Vector</code> of <code>State</code>s in <code>Julia</code> for the simulation. In <a href="https://github.com/edwardlavender/Patter.jl" class="external-link"><code>Patter.jl</code></a>, the simulation of subsequent states depends on the input state and the movement model.</p>
<p>The state must match the movement model (see <code><a href="ModelMove.html">ModelMove</a></code>):</p><ul><li><p>For <code>"StateXY"</code>, a movement model that simulates step lengths and headings, and updates state components (that is, <code>x</code> and <code>y</code> coordinates), is required;</p></li>
<li><p>For <code>"StateXYZ"</code>, a movement model that simulates step lengths, headings and depths, and updates state components (that is, <code>x</code>, <code>y</code> and <code>z</code> coordinates), is required;</p></li>
<li><p>For <code>"StateCXY"</code>, a movement model that simulates step lengths and turning angles, and updates <code>x</code>, <code>y</code>, <code>heading</code> state components, is required.</p></li>
<li><p>For <code>"StateCXYZ"</code>, a movement model that simulates step lengths, turning angles and changes in depth, and updates <code>x</code>, <code>y</code>, <code>z</code> and <code>heading</code> state components, is required.</p></li>
</ul><p>To use custom <code><a href="ModelObs.html">ModelObs</a></code> sub-types, see Examples.</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p>The routines in <code><a href="patter.html">patter</a></code> for the simulation of individual movements, observations and statistical modelling are built upon three Abstract Types defined in <code>Julia</code>:</p><ul><li><p>See <code>State</code> for individual-state (location) structures;</p></li>
<li><p>See <code><a href="ModelMove.html">ModelMove</a></code> for movement model structures;</p></li>
<li><p>See <code><a href="ModelObs.html">ModelObs</a></code> for observation model structures;</p></li>
</ul></div>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Edward Lavender</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># Patter contains multiple built-in `State` and `ModelMove` sub-types that you can use</span></span></span>
<span class="r-in"><span><span class="co"># ... (with custom parameters) simulate movements and for particle filtering.</span></span></span>
<span class="r-in"><span><span class="co"># To use a new sub-type, follow the workflow below. Some extra work is required</span></span></span>
<span class="r-in"><span><span class="co"># ... because we have to register the sub-type in `Julia` and write the</span></span></span>
<span class="r-in"><span><span class="co"># ... required methods to simulate initial states, movement and/or</span></span></span>
<span class="r-in"><span><span class="co"># ... evaluate movement densities.</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="patter_run.html">patter_run</a></span><span class="op">(</span>.julia <span class="op">=</span> <span class="cn">TRUE</span>, .geospatial <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/JuliaInterop/JuliaCall" class="external-link">JuliaCall</a></span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://testthat.r-lib.org" class="external-link">testthat</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">#### Julia set up</span></span></span>
<span class="r-in"><span>  <span class="co"># Connect to Julia</span></span></span>
<span class="r-in"><span>  <span class="va">julia</span> <span class="op">&lt;-</span> <span class="fu"><a href="julia_connect.html">julia_connect</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="co"># Set seed</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="set_seed.html">set_seed</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="co"># Export map to Julia</span></span></span>
<span class="r-in"><span>  <span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="datasets-mefs.html">dat_gebco</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="set_map.html">set_map</a></span><span class="op">(</span><span class="va">map</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">#### Define a `State` and a corresponding `ModelMove` instance</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># We consider a random walk in X, Y, Z</span></span></span>
<span class="r-in"><span>  <span class="co"># &gt; This is for demonstration only!</span></span></span>
<span class="r-in"><span>  <span class="co"># &gt; The structures and methods below are already directly available!</span></span></span>
<span class="r-in"><span>  <span class="co"># &gt; (See: ?StateXYZ, ?ModelMoveXYZ, ?model_move_xyz)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Define a custom `State` sub-type</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/pkg/JuliaCall/man/julia_command.html" class="external-link">julia_command</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="st">'</span></span></span>
<span class="r-in"><span><span class="st">  struct StateCustom &lt;: Patter.State</span></span></span>
<span class="r-in"><span><span class="st">    # Map value</span></span></span>
<span class="r-in"><span><span class="st">    # &gt; This is required for all states &amp; is the value on the map at (x, y)</span></span></span>
<span class="r-in"><span><span class="st">    map_value::Float64</span></span></span>
<span class="r-in"><span><span class="st">    # Coordinates</span></span></span>
<span class="r-in"><span><span class="st">    x::Float64</span></span></span>
<span class="r-in"><span><span class="st">    y::Float64</span></span></span>
<span class="r-in"><span><span class="st">    z::Float64</span></span></span>
<span class="r-in"><span><span class="st">  end</span></span></span>
<span class="r-in"><span><span class="st">  '</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Define a corresponding movement model sub-type</span></span></span>
<span class="r-in"><span>  <span class="co"># &gt; We will consider a random walk in 3D</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/pkg/JuliaCall/man/julia_command.html" class="external-link">julia_command</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="st">'</span></span></span>
<span class="r-in"><span><span class="st">  struct ModelMoveCustom{T, U, V, W, X} &lt;: Patter.ModelMove</span></span></span>
<span class="r-in"><span><span class="st">    # The environment (i.e., map)</span></span></span>
<span class="r-in"><span><span class="st">    # &gt; This defines the regions within which movements are permitted (i.e., in water)</span></span></span>
<span class="r-in"><span><span class="st">    map::T</span></span></span>
<span class="r-in"><span><span class="st">    # Distribution for step lengths</span></span></span>
<span class="r-in"><span><span class="st">    mobility::U</span></span></span>
<span class="r-in"><span><span class="st">    dbn_length::V</span></span></span>
<span class="r-in"><span><span class="st">    # Distribution for headings</span></span></span>
<span class="r-in"><span><span class="st">    dbn_heading::W</span></span></span>
<span class="r-in"><span><span class="st">    # Distribution for changes in depth</span></span></span>
<span class="r-in"><span><span class="st">    dbn_z_delta::X</span></span></span>
<span class="r-in"><span><span class="st">  end</span></span></span>
<span class="r-in"><span><span class="st">  '</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Instantiate the movement model</span></span></span>
<span class="r-in"><span>  <span class="co"># &gt; We will write an R function to instantiate the movement model</span></span></span>
<span class="r-in"><span>  <span class="va">model_move_custom</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">.mobility</span> <span class="op">=</span> <span class="st">"750.0"</span>,</span></span>
<span class="r-in"><span>                       <span class="va">.dbn_length</span> <span class="op">=</span> <span class="st">"truncated(Gamma(1.0, 750.0), upper = 750.0)"</span>,</span></span>
<span class="r-in"><span>                       <span class="va">.dbn_heading</span> <span class="op">=</span> <span class="st">"Uniform(-pi, pi)"</span>,</span></span>
<span class="r-in"><span>                       <span class="va">.dbn_z_delta</span> <span class="op">=</span> <span class="st">"Normal(0, 3.5)"</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="co"># (optional) Verify the map (`env` in Julia) exists:</span></span></span>
<span class="r-in"><span>    <span class="co"># patter:::julia_check_exists("env")</span></span></span>
<span class="r-in"><span>    <span class="co"># Define the movement model `Julia` code as a String</span></span></span>
<span class="r-in"><span>    <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">'ModelMoveCustom(env,</span></span></span>
<span class="r-in"><span><span class="st">                                {.mobility},</span></span></span>
<span class="r-in"><span><span class="st">                                {.dbn_length},</span></span></span>
<span class="r-in"><span><span class="st">                                {.dbn_heading},</span></span></span>
<span class="r-in"><span><span class="st">                                {.dbn_z_delta});'</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># (optional) Define a `Patter.states_init()` method to simulate initial states</span></span></span>
<span class="r-in"><span>  <span class="co"># * This function should accept:</span></span></span>
<span class="r-in"><span>  <span class="co"># * `state`: the state;</span></span></span>
<span class="r-in"><span>  <span class="co"># * `coords`: A `data.table` with initial coordinates (x, y and map_value);</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/pkg/JuliaCall/man/julia_command.html" class="external-link">julia_command</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="st">'</span></span></span>
<span class="r-in"><span><span class="st">  function Patter.states_init(state_type::Type{StateCustom}, coords::DataFrame)</span></span></span>
<span class="r-in"><span><span class="st">    coords.z = coords.map_value .* rand(nrow(coords))</span></span></span>
<span class="r-in"><span><span class="st">    return coords</span></span></span>
<span class="r-in"><span><span class="st">  end</span></span></span>
<span class="r-in"><span><span class="st">  '</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Define a `Patter.simulate_step()` method to update the state in Julia</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/pkg/JuliaCall/man/julia_command.html" class="external-link">julia_command</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="st">'</span></span></span>
<span class="r-in"><span><span class="st">  function Patter.simulate_step(state::StateCustom, model::ModelMoveCustom, t::Int64)</span></span></span>
<span class="r-in"><span><span class="st">    # Simulate a step length</span></span></span>
<span class="r-in"><span><span class="st">    length = rand(model.dbn_length)</span></span></span>
<span class="r-in"><span><span class="st">    # Simulate a heading</span></span></span>
<span class="r-in"><span><span class="st">    heading  = rand(model.dbn_heading)</span></span></span>
<span class="r-in"><span><span class="st">    # Calculate new x, y, z coordinates</span></span></span>
<span class="r-in"><span><span class="st">    x      = state.x + length * cos(heading)</span></span></span>
<span class="r-in"><span><span class="st">    y      = state.y + length * sin(heading)</span></span></span>
<span class="r-in"><span><span class="st">    z      = state.z + rand(model.dbn_z_delta)</span></span></span>
<span class="r-in"><span><span class="st">    # Include the map value</span></span></span>
<span class="r-in"><span><span class="st">    map_value = Patter.extract(model.map, x, y)</span></span></span>
<span class="r-in"><span><span class="st">    # Define the state</span></span></span>
<span class="r-in"><span><span class="st">    StateCustom(map_value, x, y, z)</span></span></span>
<span class="r-in"><span><span class="st">  end</span></span></span>
<span class="r-in"><span><span class="st">  '</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">#### Simulate path(s)</span></span></span>
<span class="r-in"><span>  <span class="va">timeline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="st">"2016-01-01"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                  length.out <span class="op">=</span> <span class="fl">1000L</span>, by <span class="op">=</span> <span class="st">"2 mins"</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="sim_path_walk.html">sim_path_walk</a></span><span class="op">(</span>.map <span class="op">=</span> <span class="va">map</span>,</span></span>
<span class="r-in"><span>                         .timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                         .state <span class="op">=</span> <span class="st">"StateCustom"</span>,</span></span>
<span class="r-in"><span>                         .model_move <span class="op">=</span> <span class="fu">model_move_custom</span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                         .plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">#### Simulate observations arising from the simulated path</span></span></span>
<span class="r-in"><span>  <span class="co"># We consider a pelagic animal &amp; simulate depth observations</span></span></span>
<span class="r-in"><span>  <span class="co"># At each time step, the animal may be anywhere from the surface to the seabed</span></span></span>
<span class="r-in"><span>  <span class="va">model_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ModelObsDepthUniformSeabed <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>sensor_id <span class="op">=</span> <span class="fl">1L</span>,</span></span>
<span class="r-in"><span>                                                      depth_shallow_eps <span class="op">=</span> <span class="fl">500</span>,</span></span>
<span class="r-in"><span>                                                      depth_deep_eps <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="sim_observations.html">sim_observations</a></span><span class="op">(</span>.timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                          .model_obs <span class="op">=</span> <span class="va">model_obs</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">obs</span>  <span class="op">&lt;-</span> <span class="va">obs</span><span class="op">$</span><span class="va">ModelObsDepthUniformSeabed</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="va">yobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ModelObsDepthUniformSeabed <span class="op">=</span> <span class="va">obs</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="co"># Plot simulated depth trajectory</span></span></span>
<span class="r-in"><span>  <span class="co"># * Blue: simulated time series</span></span></span>
<span class="r-in"><span>  <span class="co"># * Grey: seabed depth for simulated time series</span></span></span>
<span class="r-in"><span>  <span class="va">ylim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">obs</span><span class="op">$</span><span class="va">obs</span>, <span class="va">paths</span><span class="op">$</span><span class="va">map_value</span><span class="op">)</span> <span class="op">*</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">obs</span><span class="op">$</span><span class="va">timestamp</span>, <span class="va">obs</span><span class="op">$</span><span class="va">obs</span> <span class="op">*</span> <span class="op">-</span><span class="fl">1</span>, ylim <span class="op">=</span> <span class="va">ylim</span>, col <span class="op">=</span> <span class="st">"royalblue"</span>, type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">timestamp</span>, <span class="va">paths</span><span class="op">$</span><span class="va">map_value</span> <span class="op">*</span> <span class="op">-</span><span class="fl">1</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="co"># &gt; The individual ranges from the seabed to the surface</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">obs</span><span class="op">$</span><span class="va">obs</span> <span class="op">-</span> <span class="va">paths</span><span class="op">$</span><span class="va">map_value</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">#### Run the forward filter</span></span></span>
<span class="r-in"><span>  <span class="co"># (optional) Define initial states, by:</span></span></span>
<span class="r-in"><span>  <span class="co"># A) Starting the filter in the correct location by masking `.map`</span></span></span>
<span class="r-in"><span>  <span class="co"># B) Specifying a complete data.table of initial state(s)</span></span></span>
<span class="r-in"><span>  <span class="va">origin</span>       <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/setValues.html" class="external-link">setValues</a></span><span class="op">(</span><span class="va">map</span>, <span class="cn">NA</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">cell</span>         <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/xyCellFrom.html" class="external-link">cellFromXY</a></span><span class="op">(</span><span class="va">map</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">paths</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">origin</span><span class="op">[</span><span class="va">cell</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">paths</span><span class="op">$</span><span class="va">map_value</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="set_map.html">set_map</a></span><span class="op">(</span><span class="va">origin</span>, .as_Raster <span class="op">=</span> <span class="cn">TRUE</span>, .as_GeoArray <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="co"># Run the filter</span></span></span>
<span class="r-in"><span>  <span class="va">fwd</span> <span class="op">&lt;-</span> <span class="fu"><a href="pf_filter.html">pf_filter</a></span><span class="op">(</span>.timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                   .state <span class="op">=</span> <span class="st">"StateCustom"</span>,</span></span>
<span class="r-in"><span>                   .yobs <span class="op">=</span> <span class="va">yobs</span>,</span></span>
<span class="r-in"><span>                   .model_move <span class="op">=</span> <span class="fu">model_move_custom</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="co"># Visualise reconstructed time series</span></span></span>
<span class="r-in"><span>  <span class="co"># * Black: particle depths</span></span></span>
<span class="r-in"><span>  <span class="co"># * Blue: simulated time series</span></span></span>
<span class="r-in"><span>  <span class="va">ylim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">fwd</span><span class="op">$</span><span class="va">states</span><span class="op">$</span><span class="va">z</span>, <span class="va">obs</span><span class="op">$</span><span class="va">obs</span>, <span class="va">paths</span><span class="op">$</span><span class="va">map_value</span><span class="op">)</span> <span class="op">*</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fwd</span><span class="op">$</span><span class="va">states</span><span class="op">$</span><span class="va">timestamp</span>, <span class="va">fwd</span><span class="op">$</span><span class="va">states</span><span class="op">$</span><span class="va">z</span> <span class="op">*</span> <span class="op">-</span><span class="fl">1</span>, ylim <span class="op">=</span> <span class="va">ylim</span>, pch <span class="op">=</span> <span class="st">"."</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">obs</span><span class="op">$</span><span class="va">timestamp</span>, <span class="va">obs</span><span class="op">$</span><span class="va">obs</span> <span class="op">*</span> <span class="op">-</span><span class="fl">1</span> , col <span class="op">=</span> <span class="st">"royalblue"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">#### Run the backward filter</span></span></span>
<span class="r-in"><span>  <span class="co"># Define origin</span></span></span>
<span class="r-in"><span>  <span class="va">origin</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/setValues.html" class="external-link">setValues</a></span><span class="op">(</span><span class="va">map</span>, <span class="cn">NA</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">n</span>            <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">paths</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">cell</span>         <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/xyCellFrom.html" class="external-link">cellFromXY</a></span><span class="op">(</span><span class="va">map</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">paths</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">n</span><span class="op">]</span>, <span class="va">paths</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">n</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">origin</span><span class="op">[</span><span class="va">cell</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">paths</span><span class="op">$</span><span class="va">map_value</span><span class="op">[</span><span class="va">n</span><span class="op">]</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="set_map.html">set_map</a></span><span class="op">(</span><span class="va">origin</span>, .as_Raster <span class="op">=</span> <span class="cn">TRUE</span>, .as_GeoArray <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="co"># Run the filter</span></span></span>
<span class="r-in"><span>  <span class="va">bwd</span> <span class="op">&lt;-</span> <span class="fu"><a href="pf_filter.html">pf_filter</a></span><span class="op">(</span>.timeline <span class="op">=</span> <span class="va">timeline</span>,</span></span>
<span class="r-in"><span>                   .state <span class="op">=</span> <span class="st">"StateCustom"</span>,</span></span>
<span class="r-in"><span>                   .yobs <span class="op">=</span> <span class="va">yobs</span>,</span></span>
<span class="r-in"><span>                   .model_move <span class="op">=</span> <span class="fu">model_move_custom</span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                   .direction <span class="op">=</span> <span class="st">"backward"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">#### Run the smoother</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Write a `Patter.logpdf_step()` method</span></span></span>
<span class="r-in"><span>  <span class="co"># ... to evaluate the unnormalised log probability (density)</span></span></span>
<span class="r-in"><span>  <span class="co"># ... of an unrestricted step from one state to another</span></span></span>
<span class="r-in"><span>  <span class="co"># See: julia_help("Patter.logpdf_step")</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/pkg/JuliaCall/man/julia_command.html" class="external-link">julia_command</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="st">'</span></span></span>
<span class="r-in"><span><span class="st">  function Patter.logpdf_step(state_from::StateCustom, state_to::StateCustom,</span></span></span>
<span class="r-in"><span><span class="st">                              model_move::ModelMoveCustom,</span></span></span>
<span class="r-in"><span><span class="st">                              t::Int64,</span></span></span>
<span class="r-in"><span><span class="st">                              length::Float64, heading::Float64)</span></span></span>
<span class="r-in"><span><span class="st">      # Calculate change in depth</span></span></span>
<span class="r-in"><span><span class="st">      z_delta = state_to.z - state_from.z</span></span></span>
<span class="r-in"><span><span class="st">      # Evaluate unnormalised log probability</span></span></span>
<span class="r-in"><span><span class="st">      logpdf(model_move.dbn_length, length) +</span></span></span>
<span class="r-in"><span><span class="st">        logpdf(model_move.dbn_heading, heading) +</span></span></span>
<span class="r-in"><span><span class="st">        logpdf(model_move.dbn_z_delta, z_delta)</span></span></span>
<span class="r-in"><span><span class="st">  end</span></span></span>
<span class="r-in"><span><span class="st">  '</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># Run the smoother</span></span></span>
<span class="r-in"><span>  <span class="co"># * &gt;500 particles are required here to ensure</span></span></span>
<span class="r-in"><span>  <span class="co"># ... sufficient matching between `fwd` &amp; `bwd`</span></span></span>
<span class="r-in"><span>  <span class="va">smo</span> <span class="op">&lt;-</span> <span class="fu"><a href="pf_smoother_two_filter.html">pf_smoother_two_filter</a></span><span class="op">(</span>.n_particle <span class="op">=</span> <span class="fl">550L</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co">#### (optional) Map UD</span></span></span>
<span class="r-in"><span>  <span class="co"># map_dens(map, .coord = smo$states)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Attaching package: ‘testthat’</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following object is masked from ‘package:dplyr’:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     matches</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> `Julia` already connected. Set `.socket = TRUE` to reconnect.</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Use `seq.POSIXt()` with `from`, `to` and `by` rather than `length.out` for faster handling of time stamps.</span>
<span class="r-plt img"><img src="State-1.png" alt="" width="700" height="433"></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Use `seq.POSIXt()` with `from`, `to` and `by` rather than `length.out` for faster handling of time stamps.</span>
<span class="r-plt img"><img src="State-2.png" alt="" width="700" height="433"></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` called @ 2025-03-13 20:42:18... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` called @ 2025-03-13 20:42:18... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 20:42:18: Setting initial states... </span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Use `seq.POSIXt()` with `from`, `to` and `by` rather than `length.out` for faster handling of time stamps.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 20:42:19: Setting observations dictionary... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` call ended @ 2025-03-13 20:42:19 (duration: ~1 sec(s)). </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 20:42:19: Running filter... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #0000BB;">Message: On iteration 1 ...</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #0000BB;">Message: Running filter for batch 1 / 1 ...</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 20:42:19: Collating outputs... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` call ended @ 2025-03-13 20:42:20 (duration: ~2 sec(s)). </span>
<span class="r-plt img"><img src="State-3.png" alt="" width="700" height="433"></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` called @ 2025-03-13 20:42:20... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` called @ 2025-03-13 20:42:20... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 20:42:20: Setting initial states... </span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Use `seq.POSIXt()` with `from`, `to` and `by` rather than `length.out` for faster handling of time stamps.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 20:42:20: Setting observations dictionary... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter_init()` call ended @ 2025-03-13 20:42:20 (duration: ~0 sec(s)). </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 20:42:20: Running filter... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #0000BB;">Message: On iteration 1 ...</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #0000BB;">Message: Running filter for batch 1 / 1 ...</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 20:42:20: Collating outputs... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_filter()` call ended @ 2025-03-13 20:42:20 (duration: ~0 sec(s)). </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_smoother_two_filter()` called @ 2025-03-13 20:42:20... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 20:42:20: Running smoother... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #0000BB;">Message: Running smoother for batch 1 / 1 ...</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #0000BB;">Message: Precomputing normalisation constants for batch ...</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #0000BB;">Message: Smoothing ...</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ... 20:42:24: Collating outputs... </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> `patter::pf_smoother_two_filter()` call ended @ 2025-03-13 20:42:24 (duration: ~4 sec(s)). </span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Edward Lavender.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer></div>






  </body></html>

